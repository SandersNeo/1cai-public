version: '3.8'

services:
  # --- Foundation: Database ---
  postgres:
    image: pgvector/pgvector:pg17
    container_name: 1c-ai-postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: change_me_in_prod
      POSTGRES_DB: enterprise_os
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - enterprise-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d enterprise_os"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Foundation: Cache (Added for NocoBase) ---
  redis:
    image: redis:alpine
    container_name: 1c-ai-redis
    networks:
      - enterprise-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Foundation: Identity (IAM) ---
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: 1c-ai-keycloak
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/enterprise_os
      KC_DB_USERNAME: admin
      KC_DB_PASSWORD: change_me_in_prod
      KC_DB_SCHEMA: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - enterprise-net

  # --- Foundation: Event Bus (Legacy) ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: 1c-ai-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: change_me_in_prod
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    networks:
      - enterprise-net

  # --- Foundation: Event Bus (Modern) ---
  nats:
    image: nats:2.10-alpine
    container_name: 1c-ai-nats
    ports:
      - "4222:4222" # Client
      - "8222:8222" # HTTP Monitoring
    command: "-js -m 8222" # Enable JetStream & Monitoring
    networks:
      - enterprise-net

  # --- Core App: Business Workspace (NocoBase) ---
  nocobase:
    image: nocobase/nocobase:latest
    container_name: 1c-ai-nocobase
    environment:
      DB_DIALECT: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: admin
      DB_PASSWORD: change_me_in_prod
      DB_DATABASE: enterprise_os
      DB_SCHEMA: nocobase
      REDIS_HOST: redis
      REDIS_PORT: 6379
      APP_KEY: secure-app-key-change-me
    ports:
      - "13000:13000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - enterprise-net

  # --- Core App: Developer Workspace (VS Code Server) ---
  vscode:
    image: lscr.io/linuxserver/code-server:latest
    container_name: 1c-ai-vscode
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Etc/UTC
      PASSWORD: password # Simple password for now, will integrate Keycloak later
      DEFAULT_WORKSPACE: /config/workspace
    volumes:
      - vscode_config:/config
      - c:/1cAI:/config/workspace # Mount host project for editing
    ports:
      - "8000:8443"
    networks:
      - enterprise-net

  # --- Core App: Operations Workspace (Portainer) ---
  portainer:
    image: portainer/portainer-ce:latest
    container_name: 1c-ai-portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - "9000:9000"
    networks:
      - enterprise-net

  # --- Data Flow: Git Server (Gitea) ---
  gitea:
    image: gitea/gitea:1.21
    container_name: 1c-ai-gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=admin
      - GITEA__database__PASSWD=change_me_in_prod
    restart: always
    networks:
      - enterprise-net
    volumes:
      - gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "222:22"
    depends_on:
      postgres:
        condition: service_healthy

  # --- Core App: Unified Shell (Portal) ---
  portal:
    build: ./src/web/portal-shell
    container_name: 1c-ai-portal
    ports:
      - "80:80"
    networks:
      - enterprise-net
    depends_on:
      - nocobase
      - vscode
      - portainer
      - gitea

  # --- Collaboration: Real-time Engine ---
  collab-service:
    build:
      context: .
      dockerfile: src/collab/Dockerfile
    container_name: 1c-ai-collab
    ports:
      - "8002:8002"
    volumes:
      - ./src/collab:/app/src/collab
    networks:
      - enterprise-net
    restart: unless-stopped

  # --- Data Flow: 1C Sync Agent ---
  git-sync:
    image: python:3.11-slim
    container_name: 1c-ai-git-sync
    working_dir: /app
    volumes:
      - c:/1cAI:/app # Mount source code
      - git_sync_data:/data
    command: sh -c "pip install pydantic && python -u src/modules/git_sync/service.py"
    environment:
      - GIT_SERVER_URL=http://gitea:3000
      - GIT_USER=1c-sync-bot
      - GIT_PASSWORD=bot-password
      - RABBITMQ_HOST=rabbitmq
      - PYTHONPATH=/app
    networks:
      - enterprise-net
    depends_on:
      - gitea
      - rabbitmq

  # --- Security: Observability (Wazuh) ---
  wazuh:
    image: wazuh/wazuh-manager:4.7.2
    container_name: 1c-ai-wazuh
    hostname: wazuh-manager
    restart: always
    ports:
      - "1514:1514"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword1!
    volumes:
      - wazuh_certificates:/wazuh-config-mount/etc/certs
      - ./config/wazuh_manager/filebeat.yml:/etc/filebeat/filebeat.yml
    networks:
      enterprise-net:
        ipv4_address: 172.20.0.11
    depends_on:
      - wazuh-indexer

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.7.2
    container_name: 1c-ai-wazuh-dashboard
    hostname: wazuh-dashboard
    restart: always
    ports:
      - "443:5601"
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword1!
      - WAZUH_API_URL=https://wazuh:55000
    volumes:
      - wazuh_certificates:/usr/share/wazuh-dashboard/certs
    depends_on:
      - wazuh-indexer
      - wazuh
    networks:
      enterprise-net:
        ipv4_address: 172.20.0.12

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.7.2
    container_name: 1c-ai-wazuh-indexer
    hostname: wazuh-indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "discovery.type=single-node"
    volumes:
      - wazuh_indexer_data:/var/lib/wazuh-indexer
      - wazuh_certificates:/usr/share/wazuh-indexer/config/certs
      - ./config/wazuh_indexer/opensearch.yml:/usr/share/wazuh-indexer/opensearch.yml
    networks:
      enterprise-net:
        ipv4_address: 172.20.0.10
        aliases:
          - wazuh.indexer
    depends_on:
      fix-wazuh-permissions:
        condition: service_completed_successfully



  fix-wazuh-permissions:
    image: busybox
    container_name: 1c-ai-fix-wazuh-permissions
    command: sh -c "chown -R 1000:1000 /certificates && chmod -R 750 /certificates"
    volumes:
      - wazuh_certificates:/certificates

    networks:
      - enterprise-net

  # --- Security: Policy Enforcement (OPA) ---
  opa:
    image: openpolicyagent/opa:latest
    container_name: 1c-ai-opa
    ports:
      - "8181:8181"
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=debug"
      - "/policies"
    volumes:
      - ./config/opa/policies:/policies

    networks:
      enterprise-net:
        ipv4_address: 172.20.0.2

volumes:
  wazuh_indexer_data:
  wazuh_certificates:
  postgres_data:
  portainer_data:
  vscode_config:
  gitea_data:
  git_sync_data:

networks:
  enterprise-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
