// [NEXUS IDENTITY] ID: -4609171942348641097 | DATE: 2025-11-19

// Тесты для интеграций с БД (Neo4j, Qdrant, PostgreSQL)
// Формат: YAxUnit
// Проверка синхронизации данных между различными хранилищами

#Область Тесты_Интеграции

// Тест: Полный цикл парсинг → сохранение → поиск
Процедура Тест_ПолныйЦикл_ПарсингСохранениеПоиск() Экспорт
    
    // Arrange (подготовка)
    Конфигурация = "ТестоваяКонфигурация";
    ИмяМодуля = "ТестовыйМодуль";
    
    // Act - 1. Парсим конфигурацию
    Метаданные = ПарсерМетаданных.Разобрать(Конфигурация);
    
    // Act - 2. Сохраняем в PostgreSQL
    PostgreSQLКлиент.Сохранить(Метаданные);
    
    // Act - 3. Синхронизируем с Neo4j
    Neo4jКлиент.СоздатьГраф(Метаданные);
    
    // Act - 4. Векторизуем и сохраняем в Qdrant
    Векторы = EmbeddingService.Векторизовать(Метаданные);
    QdrantКлиент.Добавить(Векторы);
    
    // Assert - 5. Проверяем все БД
    // PostgreSQL
    УсловиеПоиска = ЮТест.Предикат()
        .Реквизит("name").Равно(Конфигурация)
        .Получить();
    
    ЮТест.ОжидаетЧтоТаблицаБазы("configurations", "Конфигурация в PostgreSQL")
        .СодержитЗапись(УсловиеПоиска);
    
    // Neo4j (через синхронизацию с PostgreSQL)
    УсловиеМодуля = ЮТест.Предикат()
        .Реквизит("name").Равно(ИмяМодуля)
        .Получить();
    
    ЮТест.ОжидаетЧтоТаблицаБазы("modules", "Модуль в PostgreSQL (синхронизировано из Neo4j)")
        .СодержитЗапись(УсловиеМодуля);
    
КонецПроцедуры

// Тест: Векторный поиск в Qdrant
Процедура Тест_ВекторныйПоиск_Qdrant() Экспорт
    
    // Arrange (подготовка)
    ТестовыйID = "test_module_123";
    ТестовыйВектор = Новый Массив;
    ТестовыеМетаданные = Новый Структура("Имя, Код", "ТестовыйМодуль", "Код модуля");
    
    // Act (действие)
    QdrantКлиент.ДобавитьВектор(ТестовыйID, ТестовыйВектор, ТестовыеМетаданные);
    ЗапросВектор = Новый Массив;
    Результаты = QdrantКлиент.Поиск(ЗапросВектор);
    
    // Assert (проверка через YAxUnit)
    ЮТест.ОжидаетЧто(Результаты, "Результаты векторного поиска")
        .Заполнено()
        .ИмеетДлинуБольше(0);
    
    УсловиеПоиска = ЮТест.Предикат()
        .Реквизит("id").Равно(ТестовыйID)
        .Получить();
    
    ЮТест.ОжидаетЧто(Результаты, "Результаты содержат нужный элемент")
        .СодержитЭлемент(УсловиеПоиска);
    
КонецПроцедуры

// Тест: Синхронизация Neo4j с PostgreSQL
Процедура Тест_Синхронизация_Neo4jPostgreSQL() Экспорт
    
    // Arrange (подготовка)
    УзелГрафа = Новый Структура("Тип, Имя, Код", "Модуль", "ТестовыйМодуль", "Код модуля");
    
    // Act (действие)
    Neo4jКлиент.СоздатьУзел("Модуль", УзелГрафа);
    // Синхронизация происходит автоматически
    
    // Assert (проверка через PostgreSQL)
    УсловиеПоиска = ЮТест.Предикат()
        .Реквизит("name").Равно("ТестовыйМодуль")
        .Получить();
    
    ЮТест.ОжидаетЧтоТаблицаБазы("modules", "Модуль синхронизирован из Neo4j в PostgreSQL")
        .СодержитЗапись(УсловиеПоиска);
    
КонецПроцедуры

#КонецОбласти

