#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Git
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≥–æ—Ç–æ–≤–∏—Ç –∫–æ–º–º–∏—Ç

set -e

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Git..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ .gitignore
echo "[1/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ .gitignore..."
if [ ! -f .gitignore ]; then
    echo -e "${RED}‚ùå .gitignore –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ .gitignore –Ω–∞–π–¥–µ–Ω${NC}"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã –≤ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö
echo "[2/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã..."
SECRETS_FOUND=0

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–æ–≤
if git ls-files | grep -q "\.env$"; then
    echo -e "${RED}‚ùå –ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª –≤ git!${NC}"
    SECRETS_FOUND=1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
if grep -r "password.*=.*['\"].*[a-zA-Z0-9]\{8,\}" src/ --include="*.py" 2>/dev/null | grep -v "#" | grep -v "example" | head -1; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ —Ö–∞—Ä–¥–∫–æ–¥ –ø–∞—Ä–æ–ª–∏ –Ω–∞–π–¥–µ–Ω—ã${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–µ–π
if grep -r "api_key.*=.*['\"].*[a-zA-Z0-9]\{20,\}" src/ --include="*.py" 2>/dev/null | grep -v "#" | grep -v "example" | head -1; then
    echo -e "${YELLOW}‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω—ã–µ API –∫–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã${NC}"
fi

if [ $SECRETS_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö 1–°
echo "[3/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö 1–°..."
if git ls-files | grep -q "1c_configurations/.*\.xml$"; then
    echo -e "${RED}‚ùå –ù–∞–π–¥–µ–Ω—ã XML —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π 1–°!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ –ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã${NC}"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "[4/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
UNTRACKED=$(git status --porcelain | grep "^??" | wc -l)
MODIFIED=$(git status --porcelain | grep "^ M" | wc -l)

if [ $UNTRACKED -gt 0 ] || [ $MODIFIED -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:${NC}"
    echo "   - –ù–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö: $UNTRACKED"
    echo "   - –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö: $MODIFIED"
    echo ""
    echo "–§–∞–π–ª—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:"
    git status --porcelain | head -20
else
    echo -e "${GREEN}‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã${NC}"
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞
echo "[5/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞..."
if command -v flake8 &> /dev/null; then
    if flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics 2>/dev/null | head -5; then
        echo -e "${YELLOW}‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –ª–∏–Ω—Ç–µ—Ä–∞${NC}"
    else
        echo -e "${GREEN}‚úÖ –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ—à–µ–ª${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  flake8 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º${NC}"
fi

# 6. –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "[6/6] –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
echo ""
echo "=========================================="
echo "üìä –°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:"
echo "=========================================="
echo ""

if [ $SECRETS_FOUND -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: OK${NC}"
else
    echo -e "${RED}‚ùå –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: FAILED${NC}"
fi

echo -e "${GREEN}‚úÖ .gitignore: OK${NC}"
echo -e "${GREEN}‚úÖ –ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –ó–∞—â–∏—â–µ–Ω—ã${NC}"

if [ $UNTRACKED -gt 0 ] || [ $MODIFIED -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Git —Å—Ç–∞—Ç—É—Å: –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã${NC}"
    echo ""
    echo "–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤:"
    echo "  git add ."
    echo ""
    echo "–î–ª—è –∫–æ–º–º–∏—Ç–∞:"
    echo "  git commit -m 'feat: —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è'"
    echo ""
    echo "–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:"
    echo "  git push origin main"
else
    echo -e "${GREEN}‚úÖ Git —Å—Ç–∞—Ç—É—Å: –í—Å–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ${NC}"
fi

echo ""
echo "=========================================="
echo ""

