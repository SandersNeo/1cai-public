// [NEXUS IDENTITY] ID: 2855305283020618903 | DATE: 2025-11-19

﻿// Модуль: М1сAIБлокировки
// Назначение: Библиотека модулей 1С AI Stack.
//
////////////////////////////////////////////////////////////////////////////////


//Ключевые преимущества модуля:

//Простота использования
//Вместо 4-5 строк типового кода теперь одна строка:

//// Было:
//Блокировка = Новый БлокировкаДанных;
//ЭлементБлокировки = Блокировка.Добавить("Документ." + Объект.Метаданные().Имя);
//ЭлементБлокировки.УстановитьЗначение("Ссылка", Объект);
//Блокировка.Заблокировать();

//// Стало:
//М1сAIБлокировки.LockByRef(Объект);
//Универсальность

//По ссылке: М1сAIБлокировки.LockByRef(ДокументСсылка)
//По составному ключу: М1сAIБлокировки.Lock("РегистрСведений.Назначения", Новый Структура("Пользователь,Роль", Пользователь, Роль))
//Массовые блокировки: М1сAIБлокировки.LockByRefs("Справочник.Номенклатура", МассивТоваров)
//Разнотипные объекты: М1сAIБлокировки.LockByRefsAuto(СмешанныйМассив)

//Расширенные возможности

//- Поддержка ИсточникДанных и ПоляИсточника
//- Различные режимы блокировки
//- Массовые операции с оптимизацией по типам
//- Гибкая архитектура для сложных сценариев

// Примеры использования:

// Простая блокировка документа:

//М1сAIБлокировки.LockByRef(Выборка.Регистратор);

//Блокировка регистра по составному ключу:

//М1сAIБлокировки.LockRegister("РегистрСведений.Остатки",
//    Новый Структура("Номенклатура,Склад", Товар, Склад));

//Массовая разнотипная блокировка:

//СписокОбъектов = Новый Массив;
//СписокОбъектов.Добавить(ДокументСсылка);
//СписокОбъектов.Добавить(СправочникСсылка);
//М1сAIБлокировки.LockByRefsAuto(СписокОбъектов);

//Сложный сценарий с опциями:

//М1сAIБлокировки.Lock("РегистрНакопления.ТоварыНаСкладах", Неопределено,
//    Новый Структура("ИсточникДанных,ПоляИсточника",
//        Документ.Товары, Новый Массив("Номенклатура,Склад")));

#Область ПрограммныйИнтерфейс

// Блокирует объект по указанным параметрам
//
// Параметры:
//   ИмяОбъекта - Строка - Полное имя объекта метаданных (например, "Документ.РеализацияТоваровУслуг")
//   Параметры - Структура, Неопределено - Параметры блокировки, где ключи = имена полей
//   Опции - Структура, Неопределено - Дополнительные опции блокировки
//     * ИсточникДанных - ТабличнаяЧасть, Неопределено - Источник данных для блокировки
//     * Режим - РежимБлокировкиДанных - Режим блокировки (по умолчанию Исключительный)
//     * ПоляИсточника - Массив, Неопределено - Поля источника данных для использования
//
// Пример:
//   М1сAIБлокировки.Lock("Документ.РеализацияТоваровУслуг", Новый Структура("Ссылка", ДокСсылка));
//   М1сAIБлокировки.Lock("РегистрСведений.Назначения", Новый Структура("Пользователь,Роль", Пользователь, Роль));
//
Процедура Lock(ИмяОбъекта, Параметры = Неопределено, Опции = Неопределено) Экспорт
	
	Если М1сAIОбщие.Empty(ИмяОбъекта) Тогда
		Возврат;
	КонецЕсли;
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить(ИмяОбъекта);
	
	// Устанавливаем параметры блокировки
	Если Параметры <> Неопределено И ТипЗнч(Параметры) = Тип("Структура") Тогда
		Для Каждого КлючЗначение Из Параметры Цикл
			Если НЕ М1сAIОбщие.Empty(КлючЗначение.Значение) Тогда
				ЭлементБлокировки.УстановитьЗначение(КлючЗначение.Ключ, КлючЗначение.Значение);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Применяем дополнительные опции
	Если Опции <> Неопределено И ТипЗнч(Опции) = Тип("Структура") Тогда
		
		// Режим блокировки
		Если Опции.Свойство("Режим") И Опции.Режим <> Неопределено Тогда
			ЭлементБлокировки.Режим = Опции.Режим;
		КонецЕсли;
		
		// Источник данных
		Если Опции.Свойство("ИсточникДанных") И Опции.ИсточникДанных <> Неопределено Тогда
			ЭлементБлокировки.ИсточникДанных = Опции.ИсточникДанных;
			
			// Поля источника данных
			Если Опции.Свойство("ПоляИсточника") И ТипЗнч(Опции.ПоляИсточника) = Тип("Массив") Тогда
				Для Каждого ИмяПоля Из Опции.ПоляИсточника Цикл
					ЭлементБлокировки.ИспользоватьИзИсточникаДанных(ИмяПоля, ИмяПоля);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Блокировка.Заблокировать();
	
КонецПроцедуры

// Блокирует объект по ссылке (универсальный метод для любых ссылочных объектов)
//
// Параметры:
//   ОбъектСсылка - ЛюбаяСсылка - Ссылка на объект для блокировки
//   Опции - Структура, Неопределено - Дополнительные опции блокировки
//
// Пример:
//   М1сAIБлокировки.LockByRef(ДокументСсылка);
//   М1сAIБлокировки.LockByRef(СправочникСсылка, Новый Структура("Режим", РежимБлокировкиДанных.Разделяемый));
//
Процедура LockByRef(ОбъектСсылка, Опции = Неопределено) Экспорт
	
	Если М1сAIОбщие.Empty(ОбъектСсылка) Тогда
		Возврат;
	КонецЕсли;
	
	МетаданныеОбъекта = ОбъектСсылка.Метаданные();
	ИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
	Параметры = Новый Структура("Ссылка", ОбъектСсылка);
	
	Lock(ИмяОбъекта, Параметры, Опции);
	
КонецПроцедуры

// Блокирует несколько объектов одного типа по массиву ссылок
//
// Параметры:
//   ИмяОбъекта - Строка - Полное имя объекта метаданных
//   МассивСсылок - Массив - Массив ссылок для блокировки
//   Опции - Структура, Неопределено - Дополнительные опции блокировки
//
// Пример:
//   М1сAIБлокировки.LockByRefs("Справочник.Номенклатура", МассивТоваров);
//
Процедура LockByRefs(ИмяОбъекта, МассивСсылок, Опции = Неопределено) Экспорт
	
	Если М1сAIОбщие.Empty(ИмяОбъекта) ИЛИ М1сAIОбщие.Empty(МассивСсылок) Тогда
		Возврат;
	КонецЕсли;
	
	Блокировка = Новый БлокировкаДанных;
	
	Для Каждого Ссылка Из МассивСсылок Цикл
		Если НЕ М1сAIОбщие.Empty(Ссылка) Тогда
			ЭлементБлокировки = Блокировка.Добавить(ИмяОбъекта);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Ссылка);
			
			// Применяем опции к каждому элементу
			Если Опции <> Неопределено И ТипЗнч(Опции) = Тип("Структура") Тогда
				Если Опции.Свойство("Режим") И Опции.Режим <> Неопределено Тогда
					ЭлементБлокировки.Режим = Опции.Режим;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Блокировка.Заблокировать();
	
КонецПроцедуры

// Автоматически определяет тип объекта и блокирует по ссылке
//
// Параметры:
//   МассивСсылок - Массив - Массив ссылок разных типов для блокировки
//   Опции - Структура, Неопределено - Дополнительные опции блокировки
//
// Пример:
//   СписокОбъектов = Новый Массив;
//   СписокОбъектов.Добавить(ДокументСсылка);
//   СписокОбъектов.Добавить(СправочникСсылка);
//   М1сAIБлокировки.LockByRefsAuto(СписокОбъектов);
//
Процедура LockByRefsAuto(МассивСсылок, Опции = Неопределено) Экспорт
	
	Если М1сAIОбщие.Empty(МассивСсылок) Тогда
		Возврат;
	КонецЕсли;
	
	// Группируем ссылки по типам
	ОбъектыПоТипам = Новый Соответствие;
	
	Для Каждого Ссылка Из МассивСсылок Цикл
		Если НЕ М1сAIОбщие.Empty(Ссылка) Тогда
			ИмяТипа = Ссылка.Метаданные().ПолноеИмя();
			
			Если НЕ ОбъектыПоТипам.Получить(ИмяТипа) <> Неопределено Тогда
				ОбъектыПоТипам.Вставить(ИмяТипа, Новый Массив);
			КонецЕсли;
			
			ОбъектыПоТипам[ИмяТипа].Добавить(Ссылка);
		КонецЕсли;
	КонецЦикла;
	
	// Блокируем каждый тип отдельно
	Для Каждого КлючЗначение Из ОбъектыПоТипам Цикл
		LockByRefs(КлючЗначение.Ключ, КлючЗначение.Значение, Опции);
	КонецЦикла;
	
КонецПроцедуры

// Универсальная массовая блокировка разных объектов с разными параметрами
//
// Параметры:
//   МассивЭлементов - Массив - Массив структур с описанием элементов для блокировки
//     Каждый элемент содержит:
//     * Объект - Строка - Полное имя объекта метаданных
//     * Параметры - Структура - Параметры блокировки
//     * Опции - Структура, Неопределено - Дополнительные опции
//
// Пример:
//   Элементы = Новый Массив;
//   Элементы.Добавить(Новый Структура("Объект,Параметры",
//     "Справочник.Пользователи", Новый Структура("Ссылка", Пользователь)));
//   Элементы.Добавить(Новый Структура("Объект,Параметры",
//     "Документ.ЗаказПокупателя", Новый Структура("Ссылка", Заказ)));
//   М1сAIБлокировки.LockMany(Элементы);
//
Процедура LockMany(МассивЭлементов) Экспорт
	
	Если М1сAIОбщие.Empty(МассивЭлементов) Тогда
		Возврат;
	КонецЕсли;
	
	Блокировка = Новый БлокировкаДанных;
	
	Для Каждого ОписаниеЭлемента Из МассивЭлементов Цикл
		
		Если ТипЗнч(ОписаниеЭлемента) <> Тип("Структура") Тогда
			Продолжить;
		КонецЕсли;
		
		Если НЕ ОписаниеЭлемента.Свойство("Объект") ИЛИ М1сAIОбщие.Empty(ОписаниеЭлемента.Объект) Тогда
			Продолжить;
		КонецЕсли;
		
		ЭлементБлокировки = Блокировка.Добавить(ОписаниеЭлемента.Объект);
		
		// Устанавливаем параметры
		Если ОписаниеЭлемента.Свойство("Параметры") И ТипЗнч(ОписаниеЭлемента.Параметры) = Тип("Структура") Тогда
			Для Каждого КлючЗначение Из ОписаниеЭлемента.Параметры Цикл
				Если НЕ М1сAIОбщие.Empty(КлючЗначение.Значение) Тогда
					ЭлементБлокировки.УстановитьЗначение(КлючЗначение.Ключ, КлючЗначение.Значение);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		// Применяем опции
		Если ОписаниеЭлемента.Свойство("Опции") И ТипЗнч(ОписаниеЭлемента.Опции) = Тип("Структура") Тогда
			
			Опции = ОписаниеЭлемента.Опции;
			
			Если Опции.Свойство("Режим") И Опции.Режим <> Неопределено Тогда
				ЭлементБлокировки.Режим = Опции.Режим;
			КонецЕсли;
			
			Если Опции.Свойство("ИсточникДанных") И Опции.ИсточникДанных <> Неопределено Тогда
				ЭлементБлокировки.ИсточникДанных = Опции.ИсточникДанных;
				
				Если Опции.Свойство("ПоляИсточника") И ТипЗнч(Опции.ПоляИсточника) = Тип("Массив") Тогда
					Для Каждого ИмяПоля Из Опции.ПоляИсточника Цикл
						ЭлементБлокировки.ИспользоватьИзИсточникаДанных(ИмяПоля, ИмяПоля);
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Блокировка.Заблокировать();
	
КонецПроцедуры

// Блокирует регистр по составному ключу
//
// Параметры:
//   ИмяРегистра - Строка - Полное имя регистра
//   СтруктураКлюча - Структура - Структура с полями ключа регистра
//   Опции - Структура, Неопределено - Дополнительные опции блокировки
//
// Пример:
//   М1сAIБлокировки.LockRegister("РегистрСведений.НазначенияПользователей",
//     Новый Структура("Пользователь,Роль", СсылкаПользователя, СсылкаРоли));
//
Процедура LockRegister(ИмяРегистра, СтруктураКлюча, Опции = Неопределено) Экспорт
	
	Lock(ИмяРегистра, СтруктураКлюча, Опции);
	
КонецПроцедуры

// Создаёт объект блокировки без немедленного выполнения для сложных сценариев
//
// Возвращаемое значение:
//   БлокировкаДанных - Объект блокировки для дальнейшей настройки
//
// Пример:
//   Блокировка = М1сAIБлокировки.CreateLock();
//   // Дальнейшая настройка блокировки вручную
//   Блокировка.Заблокировать();
//
Функция CreateLock() Экспорт
	
	Возврат Новый БлокировкаДанных;
	
КонецФункции

// Добавляет элемент блокировки в существующую блокировку
//
// Параметры:
//   Блокировка - БлокировкаДанных - Объект блокировки
//   ИмяОбъекта - Строка - Полное имя объекта метаданных
//   Параметры - Структура, Неопределено - Параметры блокировки
//   Опции - Структура, Неопределено - Дополнительные опции
//
// Возвращаемое значение:
//   ЭлементБлокировкиДанных - Добавленный элемент блокировки
//
// Пример:
//   Блокировка = М1сAIБлокировки.CreateLock();
//   М1сAIБлокировки.AddLockElement(Блокировка, "Документ.РеализацияТоваровУслуг",
//     Новый Структура("Ссылка", ДокСсылка));
//   Блокировка.Заблокировать();
//
Функция AddLockElement(Блокировка, ИмяОбъекта, Параметры = Неопределено, Опции = Неопределено) Экспорт
	
	Если Блокировка = Неопределено ИЛИ М1сAIОбщие.Empty(ИмяОбъекта) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ЭлементБлокировки = Блокировка.Добавить(ИмяОбъекта);
	
	// Устанавливаем параметры
	Если Параметры <> Неопределено И ТипЗнч(Параметры) = Тип("Структура") Тогда
		Для Каждого КлючЗначение Из Параметры Цикл
			Если НЕ М1сAIОбщие.Empty(КлючЗначение.Значение) Тогда
				ЭлементБлокировки.УстановитьЗначение(КлючЗначение.Ключ, КлючЗначение.Значение);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Применяем опции
	Если Опции <> Неопределено И ТипЗнч(Опции) = Тип("Структура") Тогда
		
		Если Опции.Свойство("Режим") И Опции.Режим <> Неопределено Тогда
			ЭлементБлокировки.Режим = Опции.Режим;
		КонецЕсли;
		
		Если Опции.Свойство("ИсточникДанных") И Опции.ИсточникДанных <> Неопределено Тогда
			ЭлементБлокировки.ИсточникДанных = Опции.ИсточникДанных;
			
			Если Опции.Свойство("ПоляИсточника") И ТипЗнч(Опции.ПоляИсточника) = Тип("Массив") Тогда
				Для Каждого ИмяПоля Из Опции.ПоляИсточника Цикл
					ЭлементБлокировки.ИспользоватьИзИсточникаДанных(ИмяПоля, ИмяПоля);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ЭлементБлокировки;
	
КонецФункции

#КонецОбласти