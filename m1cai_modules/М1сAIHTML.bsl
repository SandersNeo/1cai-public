// [NEXUS IDENTITY] ID: -4340964862847229800 | DATE: 2025-11-19

﻿// Модуль: М1сAIHTML
// Назначение: Библиотека модулей 1С AI Stack.
//
////////////////////////////////////////////////////////////////////////////////


#Область ПрограммныйИнтерфейс

#Область РендерингHTML

// Отображает HTML контент с современными стилями
// Основная функция для вывода обработанного М1сAINoCode контента
//
// Параметры:
//   Контент - Строка - HTML или текстовое содержимое для отображения
//   Параметры - Структура - настройки отображения (опционально):
//     * Заголовок - заголовок страницы (по умолчанию "М1сAINoCode Result")
//     * ВключитьCSS - включить встроенный CSS (по умолчанию Истина)
//     * Тема - тема оформления: "light", "dark", "auto" (по умолчанию "light")
//     * ИспользоватьAside - использовать aside для контекста (по умолчанию Ложь)
//     * КонтентAside - содержимое для бокового блока
//     * ДополнительныйCSS - пользовательский CSS для добавления
//     * ДополнительныйJS - пользовательский JavaScript для добавления
//
// Возвращаемое значение:
//   Строка - полный HTML документ, готовый для отображения
//
Function Display(Контент, Параметры = Неопределено) Export
	
	// Параметры по умолчанию
	Настройки = ПолучитьНастройкиПоУмолчанию();
	
	// Переопределяем настройки из параметров
	Если Параметры <> Неопределено Тогда
		Для Каждого Элемент Из Параметры Цикл
			Настройки.Вставить(Элемент.Ключ, Элемент.Значение);
		КонецЦикла;
	КонецЕсли;
	
	// Собираем HTML документ
	HTML = "";
	
	// DOCTYPE и открытие HTML
	HTML = HTML + "<!DOCTYPE html>" + Символы.ПС;
	HTML = HTML + "<html lang='ru'>" + Символы.ПС;
	HTML = HTML + "<head>" + Символы.ПС;
	HTML = HTML + "<meta charset='UTF-8'>" + Символы.ПС;
	HTML = HTML + "<meta name='viewport' content='width=device-width, initial-scale=1.0'>" + Символы.ПС;
	HTML = HTML + "<title>" + Настройки.Заголовок + "</title>" + Символы.ПС;
	
	// CSS стили
	Если Настройки.ВключитьCSS Тогда
		HTML = HTML + М1сAICSS.GetModernCSS(Истина, Настройки.Тема) + Символы.ПС;
	КонецЕсли;
	
	// Дополнительный CSS
	Если НЕ ПустаяСтрока(Настройки.ДополнительныйCSS) Тогда
		HTML = HTML + "<style>" + Символы.ПС;
		HTML = HTML + Настройки.ДополнительныйCSS + Символы.ПС;
		HTML = HTML + "</style>" + Символы.ПС;
	КонецЕсли;
	
	HTML = HTML + "</head>" + Символы.ПС;
	HTML = HTML + "<body>" + Символы.ПС;
	
	// Контент
	Если Настройки.ИспользоватьAside И НЕ ПустаяСтрока(Настройки.КонтентAside) Тогда
		// Flexbox layout с aside
		HTML = HTML + "<flexcontent>" + Символы.ПС;
		HTML = HTML + "<main>" + Символы.ПС;
		HTML = HTML + Контент + Символы.ПС;
		HTML = HTML + "</main>" + Символы.ПС;
		HTML = HTML + "<aside>" + Символы.ПС;
		HTML = HTML + Настройки.КонтентAside + Символы.ПС;
		HTML = HTML + "</aside>" + Символы.ПС;
		HTML = HTML + "</flexcontent>" + Символы.ПС;
	Иначе
		// Простой контент без aside
		HTML = HTML + "<main>" + Символы.ПС;
		HTML = HTML + Контент + Символы.ПС;
		HTML = HTML + "</main>" + Символы.ПС;
	КонецЕсли;
	
	// Дополнительный JavaScript
	Если НЕ ПустаяСтрока(Настройки.ДополнительныйJS) Тогда
		HTML = HTML + "<script>" + Символы.ПС;
		HTML = HTML + Настройки.ДополнительныйJS + Символы.ПС;
		HTML = HTML + "</script>" + Символы.ПС;
	КонецЕсли;
	
	HTML = HTML + "</body>" + Символы.ПС;
	HTML = HTML + "</html>";
	
	Возврат HTML;
	
КонецФункции

// Создает быстрый HTML с минимальными стилями
// Используется когда нужна максимальная скорость рендеринга
//
// Параметры:
//   Контент - Строка - содержимое для отображения
//   Заголовок - Строка - заголовок страницы (опционально)
//
// Возвращаемое значение:
//   Строка - минимальный HTML документ
//
Function DisplayQuick(Контент, Заголовок = "М1сAINoCode") Export
	
	HTML = "<!DOCTYPE html>" + Символы.ПС;
	HTML = HTML + "<html><head>" + Символы.ПС;
	HTML = HTML + "<meta charset='UTF-8'>" + Символы.ПС;
	HTML = HTML + "<title>" + Заголовок + "</title>" + Символы.ПС;
	HTML = HTML + М1сAICSS.GetMinimalCSS() + Символы.ПС;
	HTML = HTML + "</head><body>" + Символы.ПС;
	HTML = HTML + "<main>" + Контент + "</main>" + Символы.ПС;
	HTML = HTML + "</body></html>";
	
	Возврат HTML;
	
КонецФункции

#КонецОбласти

#Область СозданиеЭлементов

// Создает HTML тег с указанными параметрами
// Универсальная функция для создания любого тега
//
// Параметры:
//   ИмяТега - Строка - имя HTML тега (например "div", "p", "span")
//   Текст - Строка - содержимое тега (по умолчанию "")
//   Классы - Строка, Массив - CSS классы (опционально)
//   Стиль - Строка - inline стили (опционально)
//   ID - Строка - идентификатор элемента (опционально)
//   Атрибуты - Структура - дополнительные атрибуты (опционально)
//
// Возвращаемое значение:
//   Строка - HTML код элемента
//
Function Tag(ИмяТега, Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	
	ТегHTML = "<" + ИмяТега;
	
	// Классы
	СтрокаКлассов = "";
	Если М1сAIПроверки.IsArray(Классы) Тогда
		Для Каждого Класс Из Классы Цикл
			СтрокаКлассов = СтрокаКлассов + " " + Класс;
		КонецЦикла;
	ИначеЕсли М1сAIПроверки.IsString(Классы) Тогда
		СтрокаКлассов = Классы;
	КонецЕсли;
	
	Если СтрокаКлассов <> "" Тогда
		ТегHTML = ТегHTML + " class='" + СокрЛП(СтрокаКлассов) + "'";
	КонецЕсли;
	
	// ID
	Если ID <> Неопределено Тогда
		ТегHTML = ТегHTML + " id='" + ID + "'";
	КонецЕсли;
	
	// Стиль
	Если Стиль <> Неопределено Тогда
		ТегHTML = ТегHTML + " style='" + Стиль + "'";
	КонецЕсли;
	
	// Дополнительные атрибуты
	Если Атрибуты <> Неопределено Тогда
		Для Каждого Атр Из Атрибуты Цикл
			ТегHTML = ТегHTML + " " + Атр.Ключ + "='" + Атр.Значение + "'";
		КонецЦикла;
	КонецЕсли;
	
	// --- ИСПРАВЛЕННЫЙ БЛОК ---
	// Проверка на самозакрывающиеся теги
	
	// 1. Создаем массив из строки с тегами
	МассивСамозакрывающихсяТегов = СтрРазделить("br,hr,img,input,meta,link,area,base,col,embed,source,track,wbr", ",");
	
	// 2. Ищем точное совпадение имени тега в массиве
	Если МассивСамозакрывающихсяТегов.Найти(НРег(ИмяТега)) <> Неопределено Тогда
		// Если нашли - тег самозакрывающийся
		ТегHTML = ТегHTML + " />";
	Иначе
		// Если не нашли - обычный парный тег
		ТегHTML = ТегHTML + ">" + Текст + "</" + ИмяТега + ">";
	КонецЕсли;
	
	Возврат ТегHTML;
	
КонецФункции

// Алиас для Tag() - совместимость со старым API
Function Тег(ИмяТега, Содержимое = "", Атрибуты = "") Export
	
	Если ПустаяСтрока(ИмяТега) Тогда
		Возврат "";
	КонецЕсли;
	
	// Если атрибуты переданы строкой
	Если ТипЗнч(Атрибуты) = Тип("Строка") И НЕ ПустаяСтрока(Атрибуты) Тогда
		ТегHTML = "<" + ИмяТега + " " + Атрибуты + ">";
	Иначе
		ТегHTML = "<" + ИмяТега + ">";
	КонецЕсли;
	
	// Самозакрывающиеся теги
	СамозакрывающиесяТеги = "br,hr,img,input,meta,link,area,base,col,embed,source,track,wbr";
	Если СтрНайти(СамозакрывающиесяТеги, НРег(ИмяТега)) > 0 Тогда
		Возврат "<" + ИмяТега + ?(ПустаяСтрока(Атрибуты), "", " " + Атрибуты) + " />";
	КонецЕсли;
	
	Возврат ТегHTML + Содержимое + "</" + ИмяТега + ">";
	
КонецФункции

#КонецОбласти

#Область БыстрыеХелперы

// Создает параграф
Function P(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("p", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает div
Function D(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("div", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает span
Function Span(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("span", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H1
Function H1(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h1", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H2
Function H2(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h2", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H3
Function H3(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h3", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H4
Function H4(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h4", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H5
Function H5(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h5", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает заголовок H6
Function H6(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("h6", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает жирный текст
Function B(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("b", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает strong
Function Strong(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("strong", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает курсив
Function I(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("i", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает underline
Function U(Текст = "", Классы = Неопределено, Стиль = Неопределено, ID = Неопределено, Атрибуты = Неопределено) Export
	Возврат Tag("u", Текст, Классы, Стиль, ID, Атрибуты);
КонецФункции

// Создает перенос строки
Function Br() Export
	Возврат "<br>";
КонецФункции

// Создает горизонтальную линию
Function Hr(Классы = Неопределено) Export
	Если Классы <> Неопределено Тогда
		Возврат "<hr class='" + Классы + "'>";
	Иначе
		Возврат "<hr>";
	КонецЕсли;
КонецФункции

// Создает ссылку
// 
// Параметры:
//   Текст - Строка - текст ссылки
//   URL - Строка - адрес ссылки
//   Классы - Строка, Массив - CSS классы (опционально)
//   ОткрытьВНовойВкладке - Булево - открывать в новой вкладке (по умолчанию Ложь)
//
Function Link(Текст, URL, Классы = Неопределено, ОткрытьВНовойВкладке = Ложь) Export
	
	Атрибуты = Новый Структура;
	Атрибуты.Вставить("href", URL);
	
	Если ОткрытьВНовойВкладке Тогда
		Атрибуты.Вставить("target", "_blank");
		Атрибуты.Вставить("rel", "noopener noreferrer");
	КонецЕсли;
	
	Возврат Tag("a", Текст, Классы, Неопределено, Неопределено, Атрибуты);
	
КонецФункции

// Алиас для Link() - совместимость
Function Ссылка(URL, Текст = "", Атрибуты = "") Export
	
	Если ПустаяСтрока(URL) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстСсылки = ?(ПустаяСтрока(Текст), URL, Текст);
	АтрибутыПолные = "href=""" + EscapeHTML(URL) + """";
	
	Если НЕ ПустаяСтрока(Атрибуты) Тогда
		АтрибутыПолные = АтрибутыПолные + " " + Атрибуты;
	КонецЕсли;
	
	Возврат Тег("a", EscapeHTML(ТекстСсылки), АтрибутыПолные);
	
КонецФункции

// Создает изображение
Function Изображение(Путь, АльтТекст = "", Атрибуты = "") Export
	
	Если ПустаяСтрока(Путь) Тогда
		Возврат "";
	КонецЕсли;
	
	АтрибутыПолные = "src=""" + EscapeHTML(Путь) + """";
	
	Если НЕ ПустаяСтрока(АльтТекст) Тогда
		АтрибутыПолные = АтрибутыПолные + " alt=""" + EscapeHTML(АльтТекст) + """";
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(Атрибуты) Тогда
		АтрибутыПолные = АтрибутыПолные + " " + Атрибуты;
	КонецЕсли;
	
	Возврат Тег("img", "", АтрибутыПолные);
	
КонецФункции

// Создает блок кода
Function Code(КодТекст, Язык = Неопределено) Export
	
	Если Язык <> Неопределено Тогда
		Возврат "<pre class='code'><code class='" + Язык + "'>" + EscapeHTML(КодТекст) + "</code></pre>";
	Иначе
		Возврат "<pre class='code'><code>" + EscapeHTML(КодТекст) + "</code></pre>";
	КонецЕсли;
	
КонецФункции

// Создает inline код
Function InlineCode(Текст) Export
	Возврат "<code>" + EscapeHTML(Текст) + "</code>";
КонецФункции

// <doc>
//   <summary>Создает таблицу из массива данных (универсальная функция).</summary>
//   <parameters>
//     * Колонки - Массив из Строка - массив с названиями колонок (заголовки)
//     * Строки - Массив - массив данных. Может быть массивом массивов или массивом структур.
//     * Настройки - Структура - настройки отображения (опционально):
//       - КлассТаблицы - Строка - CSS класс для таблицы
//       - ЭкранироватьHTML - Булево - экранировать HTML в ячейках (по умолчанию Истина)
//   </parameters>
//   <returns>
//     Строка - HTML код таблицы
//   </returns>
// </doc>
Function Таблица(Колонки, Строки, Настройки = Неопределено) Export
	
	// Проверка входных данных
	Если Строки = Неопределено Или Строки.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	// Настройки по умолчанию
	КлассТаблицы = "";
	ЭкранироватьHTML = Истина; // По умолчанию ВКЛЮЧЕНО для безопасности
	
	Если Настройки <> Неопределено Тогда
		Попытка
			КлассТаблицы = Настройки.КлассТаблицы;
		Исключение
		КонецПопытки;
		Попытка
			ЭкранироватьHTML = Настройки.ЭкранироватьHTML;
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	// Начало таблицы
	HTML = "<table" + ?(ПустаяСтрока(КлассТаблицы), "", " class='" + КлассТаблицы + "'") + ">" + Символы.ПС;
	
	// Заголовки (thead) - их всегда экранируем
	Если Колонки <> Неопределено И Колонки.Количество() > 0 Тогда
		HTML = HTML + "<thead><tr>" + Символы.ПС;
		Для Каждого Заголовок Из Колонки Цикл
			HTML = HTML + "<th>" + EscapeHTML(Строка(Заголовок)) + "</th>" + Символы.ПС;
		КонецЦикла;
		HTML = HTML + "</tr></thead>" + Символы.ПС;
	КонецЕсли;
	
	// Тело таблицы (tbody)
	HTML = HTML + "<tbody>" + Символы.ПС;
	Для Каждого ЭлементСтроки Из Строки Цикл // <-- ИЗМЕНЕНО: корректное имя переменной
		
		HTML = HTML + "<tr>" + Символы.ПС;
		
		// Обработка строки, если это массив значений
		Если ТипЗнч(ЭлементСтроки) = Тип("Массив") Тогда
			Для Каждого Значение Из ЭлементСтроки Цикл
				ТекстЯчейки = ?(ЭкранироватьHTML, ФорматироватьЗначениеДляHTML(Значение), Строка(Значение));
				HTML = HTML + "<td>" + ТекстЯчейки + "</td>" + Символы.ПС;
			КонецЦикла;
			
			// Обработка строки, если это структура
		ИначеЕсли ТипЗнч(ЭлементСтроки) = Тип("Структура") Тогда
			// Предполагаем, что Колонки содержат ключи в нужном порядке
			Если Колонки <> Неопределено И Колонки.Количество() > 0 Тогда
				Для Каждого ИмяКолонки Из Колонки Цикл
					Значение = ?(ЭлементСтроки.Свойство(ИмяКолонки), ЭлементСтроки[ИмяКолонки], "");
					ТекстЯчейки = ?(ЭкранироватьHTML, ФорматироватьЗначениеДляHTML(Значение), Строка(Значение));
					HTML = HTML + "<td>" + ТекстЯчейки + "</td>" + Символы.ПС;
				КонецЦикла;
			Иначе
				// Если заголовков нет, выводим все свойства структуры в алфавитном порядке ключей
				МассивКлючей = Новый Массив;
				Для Каждого КлючЗначение Из ЭлементСтроки Цикл
					МассивКлючей.Добавить(КлючЗначение.Ключ);
				КонецЦикла;
				МассивКлючей.Сортировать();
				
				Для Каждого Ключ Из МассивКлючей Цикл
					ТекстЯчейки = ?(ЭкранироватьHTML, ФорматироватьЗначениеДляHTML(ЭлементСтроки[Ключ]), Строка(ЭлементСтроки[Ключ]));
					HTML = HTML + "<td>" + ТекстЯчейки + "</td>" + Символы.ПС;
				КонецЦикла;
			КонецЕсли;
		Иначе
			// Если строка - это простое значение, помещаем его в одну ячейку
			// --- ИСПРАВЛЕННАЯ СТРОКА ---
			ТекстЯчейки = ?(ЭкранироватьHTML, ФорматироватьЗначениеДляHTML(ЭлементСтроки), Строка(ЭлементСтроки));
			HTML = HTML + "<td>" + ТекстЯчейки + "</td>" + Символы.ПС;
		КонецЕсли;
		
		HTML = HTML + "</tr>" + Символы.ПС;
	КонецЦикла;
	HTML = HTML + "</tbody>" + Символы.ПС;
	HTML = HTML + "</table>";
	
	Возврат HTML;
	
КонецФункции

#КонецОбласти

#Область Компоненты

// Создает Alert компонент
//
// Параметры:
//   Текст - Строка - содержимое алерта
//   Тип - Строка - тип алерта: "info", "warn", "success", "danger" (по умолчанию "info")
//   Заголовок - Строка - заголовок алерта (опционально)
//
Function Alert(Текст, Тип = "info", Заголовок = "") Export
	
	Класс = "alert alert--" + Тип;
	
	Контент = "";
	Если НЕ ПустаяСтрока(Заголовок) Тогда
		Контент = "<strong>" + Заголовок + "</strong>";
	КонецЕсли;
	Контент = Контент + Текст;
	
	Возврат D(Контент, Класс);
	
КонецФункции

// Создает Callout компонент (аналог Alert)
Function Callout(Текст, Тип = "info", Заголовок = "") Export
	
	Класс = "callout callout--" + Тип;
	
	Контент = "";
	Если НЕ ПустаяСтрока(Заголовок) Тогда
		Контент = "<strong>" + Заголовок + "</strong>";
	КонецЕсли;
	Контент = Контент + Текст;
	
	Возврат D(Контент, Класс);
	
КонецФункции

// Создает Card компонент
//
// Параметры:
//   Контент - Строка - содержимое карточки
//   Заголовок - Строка - заголовок карточки (опционально)
//   Классы - Строка - дополнительные классы (опционально)
//
Function Card(Контент, Заголовок = "", Классы = Неопределено) Export
	
	Содержимое = "";
	Если НЕ ПустаяСтрока(Заголовок) Тогда
		Содержимое = H3(Заголовок);
	КонецЕсли;
	Содержимое = Содержимое + Контент;
	
	КлассыКарточки = "card";
	Если Классы <> Неопределено Тогда
		КлассыКарточки = КлассыКарточки + " " + Классы;
	КонецЕсли;
	
	Возврат D(Содержимое, КлассыКарточки);
	
КонецФункции

// Создает Button компонент
//
// Параметры:
//   Текст - Строка - текст кнопки
//   Тип - Строка - тип кнопки: "primary", "secondary" (по умолчанию "primary")
//   OnClick - Строка - JavaScript код для обработки клика (опционально)
//
Function Button(Текст, Тип = "primary", OnClick = "") Export
	
	Класс = "btn";
	Если Тип = "secondary" Тогда
		Класс = Класс + " secondary";
	КонецЕсли;
	
	Атрибуты = Неопределено;
	Если НЕ ПустаяСтрока(OnClick) Тогда
		Атрибуты = Новый Структура;
		Атрибуты.Вставить("onclick", OnClick);
	КонецЕсли;
	
	Возврат Tag("button", Текст, Класс, Неопределено, Неопределено, Атрибуты);
	
КонецФункции

// Создает Badge/Pill компонент
Function Badge(Текст, Тип = "pill") Export
	Возврат Span(Текст, Тип);
КонецФункции

// Создает Chip компонент
Function Chip(Текст, Иконка = "") Export
	
	Контент = "";
	Если НЕ ПустаяСтрока(Иконка) Тогда
		Контент = Span(Иконка) + " ";
	КонецЕсли;
	Контент = Контент + Текст;
	
	Возврат Span(Контент, "chip");
	
КонецФункции

// Создает Aside блок для контекста
//
// Параметры:
//   Контент - Строка - содержимое aside
//   Заголовок - Строка - заголовок блока (опционально)
//
Function Aside(Контент, Заголовок = "Контекст") Export
	
	Содержимое = "";
	Если НЕ ПустаяСтрока(Заголовок) Тогда
		Содержимое = H4(Заголовок);
	КонецЕсли;
	Содержимое = Содержимое + Контент;
	
	Возврат Tag("aside", Содержимое);
	
КонецФункции

#КонецОбласти

#Область РаботаСТаблицами

// Создает таблицу из массива данных (новый API)
//
// Параметры:
//   Данные - Массив - массив структур с данными
//   Заголовки - Массив - массив строк с названиями колонок
//   Классы - Строка - дополнительные CSS классы
//
Function Table(Данные, Заголовки = Неопределено, Классы = "") Export
	
	Если Данные.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	HTML = "<table" + ?(ПустаяСтрока(Классы), "", " class='" + Классы + "'") + ">";
	
	// Заголовки
	Если Заголовки <> Неопределено Тогда
		HTML = HTML + "<thead><tr>";
		Для Каждого Заголовок Из Заголовки Цикл
			HTML = HTML + "<th>" + Заголовок + "</th>";
		КонецЦикла;
		HTML = HTML + "</tr></thead>";
	КонецЕсли;
	
	// Данные
	HTML = HTML + "<tbody>";
	Для Каждого Строка Из Данные Цикл
		HTML = HTML + "<tr>";
		Для Каждого Элемент Из Строка Цикл
			HTML = HTML + "<td>" + Строка(Элемент.Значение) + "</td>";
		КонецЦикла;
		HTML = HTML + "</tr>";
	КонецЦикла;
	HTML = HTML + "</tbody>";
	
	HTML = HTML + "</table>";
	
	Возврат HTML;
	
КонецФункции

// Создает таблицу из табличной части 1С
//
// Параметры:
//   ТабличнаяЧасть - ТабличнаяЧасть - табличная часть документа/справочника
//   Настройки - Структура - настройки отображения (опционально):
//     * ВключатьЗаголовки - включать заголовки колонок (по умолчанию Истина)
//     * КлассТаблицы - CSS класс таблицы
//     * КлассЗаголовка - CSS класс заголовков
//     * КлассСтроки - CSS класс строк
//     * КолонкиДляВывода - массив имен колонок для вывода (по умолчанию все)
//
Function ТаблицаИзТЧ(ТабличнаяЧасть, Настройки = Неопределено) Export
	
	Если ТабличнаяЧасть = Неопределено ИЛИ ТабличнаяЧасть.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	НастройкиПоУмолчанию = Новый Структура;
	НастройкиПоУмолчанию.Вставить("ВключатьЗаголовки", Истина);
	НастройкиПоУмолчанию.Вставить("КлассТаблицы", "");
	НастройкиПоУмолчанию.Вставить("КлассЗаголовка", "");
	НастройкиПоУмолчанию.Вставить("КлассСтроки", "");
	НастройкиПоУмолчанию.Вставить("КолонкиДляВывода", Неопределено);
	
	Если Настройки <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(НастройкиПоУмолчанию, Настройки);
	КонецЕсли;
	
	КолонкиДляВывода = НастройкиПоУмолчанию.КолонкиДляВывода;
	Если КолонкиДляВывода = Неопределено Тогда
		КолонкиДляВывода = Новый Массив;
		// Перебор реквизитов табличной части по метаданным
		Попытка
			МетаданныеТЧ = ТабличнаяЧасть.Владелец().Метаданные().ТабличныеЧасти[ТабличнаяЧасть.Имя];
			Для Каждого РеквТЧ Из МетаданныеТЧ.Реквизиты Цикл
				КолонкиДляВывода.Добавить(РеквТЧ.Имя);
			КонецЦикла;
		Исключение
			// Если не удалось получить метаданные, используем все свойства первой строки
			Если ТабличнаяЧасть.Количество() > 0 Тогда
				ПерваяСтрока = ТабличнаяЧасть[0];
				Для Каждого Свойство Из ПерваяСтрока Цикл
					КолонкиДляВывода.Добавить(Свойство.Имя);
				КонецЦикла;
			КонецЕсли;
		КонецПопытки;
	КонецЕсли;
	
	СодержимоеТаблицы = "";
	
	Если НастройкиПоУмолчанию.ВключатьЗаголовки Тогда
		СтрокаЗаголовков = "";
		Для Каждого ИмяКолонки Из КолонкиДляВывода Цикл
			АтрибутыЯчейки = "";
			Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассЗаголовка) Тогда
				АтрибутыЯчейки = "class=""" + НастройкиПоУмолчанию.КлассЗаголовка + """";
			КонецЕсли;
			СтрокаЗаголовков = СтрокаЗаголовков + Тег("th", EscapeHTML(Строка(ИмяКолонки)), АтрибутыЯчейки);
		КонецЦикла;
		СодержимоеТаблицы = СодержимоеТаблицы + Тег("thead", Тег("tr", СтрокаЗаголовков));
	КонецЕсли;
	
	СодержимоеТела = "";
	Для Каждого СтрокаТЧ Из ТабличнаяЧасть Цикл
		СодержимоеСтроки = "";
		Для Каждого ИмяКолонки Из КолонкиДляВывода Цикл
			Попытка
				Значение = СтрокаТЧ[ИмяКолонки];
			Исключение
				Значение = Неопределено;
			КонецПопытки;
			ЗначениеСтрокой = ФорматироватьЗначениеДляHTML(Значение);
			СодержимоеСтроки = СодержимоеСтроки + Тег("td", ЗначениеСтрокой);
		КонецЦикла;
		
		АтрибутыСтроки = "";
		Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассСтроки) Тогда
			АтрибутыСтроки = "class=""" + НастройкиПоУмолчанию.КлассСтроки + """";
		КонецЕсли;
		
		СодержимоеТела = СодержимоеТела + Тег("tr", СодержимоеСтроки, АтрибутыСтроки);
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(СодержимоеТела) Тогда
		СодержимоеТаблицы = СодержимоеТаблицы + Тег("tbody", СодержимоеТела);
	КонецЕсли;
	
	АтрибутыТаблицы = "";
	Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассТаблицы) Тогда
		АтрибутыТаблицы = "class=""" + НастройкиПоУмолчанию.КлассТаблицы + """";
	КонецЕсли;
	
	Возврат Тег("table", СодержимоеТаблицы, АтрибутыТаблицы);
	
КонецФункции

// Создает таблицу из массива структур
Function ТаблицаИзМассива(Массив, Заголовки = Неопределено) Export
	
	Если Массив = Неопределено ИЛИ Массив.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	СодержимоеТаблицы = "";
	ПерваяСтрока = Массив[0];
	Если ТипЗнч(ПерваяСтрока) <> Тип("Структура") Тогда
		Возврат "";
	КонецЕсли;
	
	КлючиСтроки = Новый Массив;
	Для Каждого КлючЗначение Из ПерваяСтрока Цикл
		КлючиСтроки.Добавить(КлючЗначение.Ключ);
	КонецЦикла;
	
	Если Заголовки <> Неопределено Тогда
		СтрокаЗаголовков = "";
		Для Каждого Заголовок Из Заголовки Цикл
			СтрокаЗаголовков = СтрокаЗаголовков + Тег("th", EscapeHTML(Строка(Заголовок)));
		КонецЦикла;
		СодержимоеТаблицы = СодержимоеТаблицы + Тег("thead", Тег("tr", СтрокаЗаголовков));
	КонецЕсли;
	
	СодержимоеТела = "";
	Для Каждого ЭлементМассива Из Массив Цикл
		СодержимоеСтроки = "";
		Для Каждого Ключ Из КлючиСтроки Цикл
			Значение = ЭлементМассива[Ключ];
			ЗначениеСтрокой = ФорматироватьЗначениеДляHTML(Значение);
			СодержимоеСтроки = СодержимоеСтроки + Тег("td", ЗначениеСтрокой);
		КонецЦикла;
		СодержимоеТела = СодержимоеТела + Тег("tr", СодержимоеСтроки);
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(СодержимоеТела) Тогда
		СодержимоеТаблицы = СодержимоеТаблицы + Тег("tbody", СодержимоеТела);
	КонецЕсли;
	
	Возврат Тег("table", СодержимоеТаблицы);
	
КонецФункции

#КонецОбласти

#Область РаботаССписками

// Создает список из массива
Function СписокИзМассива(Массив, Тип = "ul") Export
	
	Если Массив = Неопределено ИЛИ Массив.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	СодержимоеСписка = "";
	Для Каждого Элемент Из Массив Цикл
		ЗначениеСтрокой = ФорматироватьЗначениеДляHTML(Элемент);
		СодержимоеСписка = СодержимоеСписка + Тег("li", ЗначениеСтрокой);
	КонецЦикла;
	
	Возврат Тег(Тип, СодержимоеСписка);
	
КонецФункции

#КонецОбласти

#Область РаботаСОбъектами1С

// Преобразует документ 1С в HTML
//
// Параметры:
//   ДокументСсылка - ДокументСсылка - ссылка на документ
//   Настройки - Структура - настройки отображения (опционально):
//     * КлассДокумента - CSS класс контейнера документа
//     * КлассРеквизита - CSS класс реквизита
//     * ВключатьТабличныеЧасти - включать табличные части (по умолчанию Истина)
//
Function ДокументВHTML(ДокументСсылка, Настройки = Неопределено) Export
	
	Если ДокументСсылка = Неопределено ИЛИ ДокументСсылка.Пустая() Тогда
		Возврат "";
	КонецЕсли;
	
	НастройкиПоУмолчанию = Новый Структура;
	НастройкиПоУмолчанию.Вставить("КлассДокумента", "document");
	НастройкиПоУмолчанию.Вставить("КлассРеквизита", "attribute");
	НастройкиПоУмолчанию.Вставить("ВключатьТабличныеЧасти", Истина);
	
	Если Настройки <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(НастройкиПоУмолчанию, Настройки);
	КонецЕсли;
	
	ДокументОбъект = ДокументСсылка.ПолучитьОбъект();
	МетаданныеДокумента = ДокументСсылка.Метаданные();
	
	СодержимоеHTML = "";
	Заголовок = Строка(МетаданныеДокумента.Синоним) + " №" + Строка(ДокументОбъект.Номер) + " от " + Формат(ДокументОбъект.Дата, "ДФ=dd.MM.yyyy");
	СодержимоеHTML = СодержимоеHTML + Тег("h1", EscapeHTML(Заголовок));
	
	СодержимоеРеквизитов = "";
	Для Каждого Реквизит Из МетаданныеДокумента.Реквизиты Цикл
		Если Реквизит.Имя = "Номер" ИЛИ Реквизит.Имя = "Дата" Тогда
			Продолжить; // уже в заголовке
		КонецЕсли;
		ЗначениеРеквизита = ДокументОбъект[Реквизит.Имя];
		ЗначениеСтрокой = ФорматироватьЗначениеДляHTML(ЗначениеРеквизита);
		АтрибутыРеквизита = "";
		Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассРеквизита) Тогда
			АтрибутыРеквизита = "class=""" + НастройкиПоУмолчанию.КлассРеквизита + """";
		КонецЕсли;
		СодержимоеРеквизитов = СодержимоеРеквизитов +
			Тег("div",
				Тег("strong", EscapeHTML(Строка(Реквизит.Синоним)) + ": ") + ЗначениеСтрокой,
				АтрибутыРеквизита);
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(СодержимоеРеквизитов) Тогда
		СодержимоеHTML = СодержимоеHTML + Тег("div", СодержимоеРеквизитов, "class=""attributes""");
	КонецЕсли;
	
	Если НастройкиПоУмолчанию.ВключатьТабличныеЧасти Тогда
		Для Каждого ТабличнаяЧасть Из МетаданныеДокумента.ТабличныеЧасти Цикл
			ТЧОбъект = ДокументОбъект[ТабличнаяЧасть.Имя];
			Если ТЧОбъект.Количество() > 0 Тогда
				ЗаголовокТЧ = Тег("h2", EscapeHTML(Строка(ТабличнаяЧасть.Синоним)));
				НастройкиТаблицы = Новый Структура("КлассТаблицы", "table-part");
				ТаблицаHTML = ТаблицаИзТЧ(ТЧОбъект, НастройкиТаблицы);
				СодержимоеHTML = СодержимоеHTML + ЗаголовокТЧ + ТаблицаHTML;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	АтрибутыКонтейнера = "";
	Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассДокумента) Тогда
		АтрибутыКонтейнера = "class=""" + НастройкиПоУмолчанию.КлассДокумента + """";
	КонецЕсли;
	
	Возврат Тег("div", СодержимоеHTML, АтрибутыКонтейнера);
	
КонецФункции

// Преобразует элемент справочника в HTML
//
// Параметры:
//   СправочникСсылка - СправочникСсылка - ссылка на элемент справочника
//   Настройки - Структура - настройки отображения (опционально):
//     * КлассСправочника - CSS класс контейнера
//     * КлассРеквизита - CSS класс реквизита
//     * ВключатьТабличныеЧасти - включать табличные части (по умолчанию Истина)
//
Function СправочникВHTML(СправочникСсылка, Настройки = Неопределено) Export
	
	Если СправочникСсылка = Неопределено ИЛИ СправочникСсылка.Пустая() Тогда
		Возврат "";
	КонецЕсли;
	
	НастройкиПоУмолчанию = Новый Структура;
	НастройкиПоУмолчанию.Вставить("КлассСправочника", "catalog-item");
	НастройкиПоУмолчанию.Вставить("КлассРеквизита", "attribute");
	НастройкиПоУмолчанию.Вставить("ВключатьТабличныеЧасти", Истина);
	
	Если Настройки <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(НастройкиПоУмолчанию, Настройки);
	КонецЕсли;
	
	Элемент = СправочникСсылка.ПолучитьОбъект();
	Мета = СправочникСсылка.Метаданные();
	
	СодержимоеHTML = "";
	Заголовок = Строка(Мета.Синоним) + ": " + EscapeHTML(Строка(Элемент.Наименование));
	Попытка
		Если Элемент.Свойство("Код") Тогда
			Заголовок = Заголовок + " (Код: " + EscapeHTML(Строка(Элемент.Код)) + ")";
		КонецЕсли;
	Исключение
	КонецПопытки;
	СодержимоеHTML = СодержимоеHTML + Тег("h1", Заголовок);
	
	// Реквизиты элемента
	СодержимоеРеквизитов = "";
	Для Каждого Реквизит Из Мета.Реквизиты Цикл
		Если Реквизит.Имя = "Наименование" ИЛИ Реквизит.Имя = "Код" Тогда
			Продолжить; // уже в заголовке
		КонецЕсли;
		Попытка
			ЗначениеРеквизита = Элемент[Реквизит.Имя];
		Исключение
			Продолжить;
		КонецПопытки;
		ЗначениеСтрокой = ФорматироватьЗначениеДляHTML(ЗначениеРеквизита);
		АтрибутыРеквизита = "";
		Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассРеквизита) Тогда
			АтрибутыРеквизита = "class=""" + НастройкиПоУмолчанию.КлассРеквизита + """";
		КонецЕсли;
		СодержимоеРеквизитов = СодержимоеРеквизитов +
			Тег("div",
				Тег("strong", EscapeHTML(Строка(Реквизит.Синоним)) + ": ") + ЗначениеСтрокой,
				АтрибутыРеквизита);
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(СодержимоеРеквизитов) Тогда
		СодержимоеHTML = СодержимоеHTML + Тег("div", СодержимоеРеквизитов, "class=""attributes""");
	КонецЕсли;
	
	// Табличные части справочника (если есть)
	Если НастройкиПоУмолчанию.ВключатьТабличныеЧасти И Мета.ТабличныеЧасти.Количество() > 0 Тогда
		Для Каждого ТЧ Из Мета.ТабличныеЧасти Цикл
			ТЧОбъект = Элемент[ТЧ.Имя];
			Если ТЧОбъект.Количество() > 0 Тогда
				ЗаголовокТЧ = Тег("h2", EscapeHTML(Строка(ТЧ.Синоним)));
				НастройкиТаблицы = Новый Структура("КлассТаблицы", "table-part");
				ТаблицаHTML = ТаблицаИзТЧ(ТЧОбъект, НастройкиТаблицы);
				СодержимоеHTML = СодержимоеHTML + ЗаголовокТЧ + ТаблицаHTML;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	АтрибутыКонтейнера = "";
	Если НЕ ПустаяСтрока(НастройкиПоУмолчанию.КлассСправочника) Тогда
		АтрибутыКонтейнера = "class=""" + НастройкиПоУмолчанию.КлассСправочника + """";
	КонецЕсли;
	
	Возврат Тег("div", СодержимоеHTML, АтрибутыКонтейнера);
	
КонецФункции

#КонецОбласти

#Область СтилиИСпециальноеФорматирование

// Получает стили для печати
Function ПолучитьСтилиДляПечати() Export
	Возврат "
	|<style>
	|  * { box-sizing: border-box; }
	|  body { font-family: Arial, sans-serif; font-size: 12pt; color: #222; }
	|  h1 { font-size: 18pt; margin: 0 0 12px; }
	|  h2 { font-size: 14pt; margin: 16px 0 8px; }
	|  .attributes .attribute { margin: 2px 0; }
	|  table { border-collapse: collapse; width: 100%; margin: 8px 0 16px; }
	|  th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
	|  thead th { background: #f5f5f5; font-weight: bold; }
	|  .document, .catalog-item { padding: 12px; border: 1px solid #eee; border-radius: 6px; }
	|  .table-part { width: 100%; }
	|</style>";
КонецФункции

// Получает стили для email
Function ПолучитьСтилиДляEmail() Export
	// Базовые inline-friendly стили (без сложных селекторов)
	Возврат "
	|<style>
	|  body { margin:0; padding:0; font-family: Arial, sans-serif; font-size: 14px; }
	|  table { border-collapse: collapse; width: 100%; }
	|  th, td { border: 1px solid #e0e0e0; padding: 8px; }
	|  h1 { font-size: 18px; margin: 16px 0 8px; }
	|  h2 { font-size: 16px; margin: 12px 0 6px; }
	|</style>";
КонецФункции

// Вставляет изображение в формате Base64
Function ВставитьИзображениеBase64(ДвоичныеДанные, ТипИзображения = "png") Export
	Если ДвоичныеДанные = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	Попытка
		Б64 = Base64Строка(ДвоичныеДанные);
		Возврат "<img src='data:image/" + ТипИзображения + ";base64," + Б64 + "' />";
	Исключение
		Возврат "";
	КонецПопытки;
КонецФункции

#КонецОбласти

#Область Утилиты

// Экранирует HTML специальные символы
// Предотвращает XSS атаки
//
// Параметры:
//   Текст - Строка - текст для экранирования
//
// Возвращаемое значение:
//   Строка - экранированный текст
//
Function EscapeHTML(Текст) Export
	
	Если Текст = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	Результат = Строка(Текст);
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "'", "&#39;");
	
	Возврат Результат;
	
КонецФункции

// Алиас для совместимости
Function ЭкранироватьHTML(Текст) Export
	Возврат EscapeHTML(Текст);
КонецФункции

// Создает grid контейнер
//
// Параметры:
//   Элементы - Массив - массив HTML элементов
//   Колонки - Число - минимальное количество колонок (по умолчанию 3)
//
Function Grid(Элементы, Колонки = 3) Export
	
	HTML = "<div class='grid'>";
	
	Для Каждого Элемент Из Элементы Цикл
		HTML = HTML + Элемент;
	КонецЦикла;
	
	HTML = HTML + "</div>";
	
	Возврат HTML;
	
КонецФункции

// Форматирует значение для вывода в HTML
Function ФорматироватьЗначениеДляHTML(Значение) Export
	
	Если НЕ ЗначениеЗаполнено(Значение) Тогда
		Возврат "&mdash;";
	КонецЕсли;
	
	ТипЗначения = ТипЗнч(Значение);
	
	Если ТипЗначения = Тип("Дата") Тогда
		Возврат EscapeHTML(Формат(Значение, "ДФ=dd.MM.yyyy"));
	КонецЕсли;
	
	Если ТипЗначения = Тип("Число") Тогда
		// Безопасный дефолтный формат — две десятки, разделитель тысяч — пробел
		Возврат EscapeHTML(Формат(Значение, "ЧДЦ=2; ЧРГ=' '; ЧН=0,00"));
	КонецЕсли;
	
	Если ТипЗначения = Тип("Булево") Тогда
		Возврат ?(Значение, "Да", "Нет");
	КонецЕсли;
	
	// Ссылочные типы — отдаем представление
	Попытка
		Если ТипЗначения.Потомок(Тип("Ссылка")) Тогда
			Попытка
				Возврат EscapeHTML(Строка(Значение.Представление()));
			Исключение
				Возврат EscapeHTML(Строка(Значение));
			КонецПопытки;
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	// Массивы / Соответствия / Структуры — в строку по умолчанию
	Если ТипЗначения = Тип("Массив") Тогда
		Буф = Новый Массив;
		Для Каждого Э Из Значение Цикл
			Буф.Добавить(Строка(Э));
		КонецЦикла;
		Возврат EscapeHTML(СтрСоединить(Буф, ", "));
	КонецЕсли;
	
	Если ТипЗначения = Тип("Структура") Тогда
		Буф = Новый Массив;
		Для Каждого П Из Значение Цикл
			Буф.Добавить(Строка(П.Ключ) + ": " + Строка(П.Значение));
		КонецЦикла;
		Возврат EscapeHTML(СтрСоединить(Буф, "; "));
	КонецЕсли;
	
	Если ТипЗначения = Тип("Соответствие") Тогда
		Буф = Новый Массив;
		Для Каждого Пара Из Значение Цикл
			Буф.Добавить(Строка(Пара.Ключ) + ": " + Строка(Пара.Значение));
		КонецЦикла;
		Возврат EscapeHTML(СтрСоединить(Буф, "; "));
	КонецЕсли;
	
	Возврат EscapeHTML(Строка(Значение));
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Function ПолучитьНастройкиПоУмолчанию()
	
	Настройки = Новый Структура;
	Настройки.Вставить("Заголовок", "М1сAINoCode Result");
	Настройки.Вставить("ВключитьCSS", Истина);
	Настройки.Вставить("Тема", "light");
	Настройки.Вставить("ИспользоватьAside", Ложь);
	Настройки.Вставить("КонтентAside", "");
	Настройки.Вставить("ДополнительныйCSS", "");
	Настройки.Вставить("ДополнительныйJS", "");
	
	Возврат Настройки;
	
КонецФункции

#КонецОбласти