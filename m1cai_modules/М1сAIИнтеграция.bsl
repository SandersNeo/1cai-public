// [NEXUS IDENTITY] ID: -4919076547668726966 | DATE: 2025-11-19

﻿// Модуль: М1сAIИнтеграция
// Назначение: Библиотека модулей 1С AI Stack.
//
////////////////////////////////////////////////////////////////////////////////


#Region М1сAIИнтеграция_ModuleMap
// М1сAIИнтеграция (flags: Server + External connection + Client)
// Requires: М1сAIСтроки, М1сAIОбщие
//
// Regions:
//   М1сAIИнтеграция_URLEncode                     – Кодирует строку для URL
//   М1сAIИнтеграция_GetPlatformsMap               – Карта поддерживаемых AI-платформ и их URL
//   М1сAIИнтеграция_NormalizePlatformName         – Нормализация имени платформы и алиасов
//   М1сAIИнтеграция_BuildURL                      – Построение URL по платформе и запросу
//   М1сAIИнтеграция_ListPlatforms                 – Список доступных платформ
//   М1сAIИнтеграция_NewRNG                        – Создание генератора случайных чисел
//   М1сAIИнтеграция_PickRandomPlatform            – Выбор случайной платформы
//   М1сAIИнтеграция_BuildEnrichedPrompt           – Формирование обогащенного промпта (8 параметров)
//   М1сAIИнтеграция_BuildRolePrompt               – Формирование промпта с ролью (НОВОЕ v1.3.0)
//   М1сAIИнтеграция_Open                          – Универсальная функция открытия AI-запроса
//   М1сAIИнтеграция_OpenWithRole                  – Открытие AI с автоматической ролью (НОВОЕ v1.3.0)
//   М1сAIИнтеграция_OpenChatGPT                   – Открыть запрос в ChatGPT
//   М1сAIИнтеграция_OpenPerplexity                – Открыть запрос в Perplexity
//   М1сAIИнтеграция_OpenBrowser                   – Открыть URL в браузере
//   М1сAIИнтеграция_SelfTest                      – Юнит-тесты модуля
#EndRegion


#Region М1сAIИнтеграция_URLEncode
// <doc>
//   <summary>Кодирует строку для использования в URL.</summary>   ✦
//   <param i="1" name="Текст" type="String">Текст для кодирования.</param>
//   <returns>String — закодированная строка для безопасной передачи в URL.</returns>
//   <locals>
//     <var name="С" type="String">Результирующая закодированная строка</var>
//   </locals>
//   <complexity cc="1"/>
//   <example>
//     Результат = М1сAIИнтеграция.URLEncode("Hello World");
//     // Ожидание: "Hello%20World"
//   </example>
// </doc>
Функция URLEncode(Текст) Экспорт //⚙
	ib = "Кодирование строки для URL"; //✍
	
	С = Строка(Текст); //✏
	С = СтрЗаменить(С, "%", "%25"); //✏
	С = СтрЗаменить(С, " ", "%20"); //✏
	С = СтрЗаменить(С, "+", "%2B"); //✏
	С = СтрЗаменить(С, "&", "%26"); //✏
	С = СтрЗаменить(С, "=", "%3D"); //✏
	С = СтрЗаменить(С, "?", "%3F"); //✏
	С = СтрЗаменить(С, "#", "%23"); //✏
	С = СтрЗаменить(С, ":", "%3A"); //✏
	
	Возврат С; //↩
КонецФункции

#Region М1сAIИнтеграция_URLEncode_Test
Функция URLEncode_Test()
	ib = "Тест URLEncode"; //✍
	
	Результат = URLEncode("Hello World"); //✏
	ОжидаемыйРезультат = "Hello%20World"; //✏
	Если Результат <> ОжидаемыйРезультат Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = URLEncode("Test: ?#&="); //✏
	ОжидаемыйРезультат = "Test%3A%20%3F%23%26%3D"; //✏
	Если Результат <> ОжидаемыйРезультат Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_GetPlatformsMap
// <doc>
//   <summary>Возвращает соответствие поддерживаемых AI-платформ и их базовых URL.</summary>   ✦
//   <returns>Соответствие — ключ: строка (имя платформы), значение: строка (шаблон URL с {q}).</returns>
//   <complexity cc="1"/>
// </doc>
Функция GetPlatformsMap() Экспорт //⚙
	ib = "Карта AI-платформ"; //✍
	
	MapURL = Новый Соответствие; //✏
	MapURL.Вставить("chatgpt",     "https://chat.openai.com/?q={q}"); //✏
	MapURL.Вставить("perplexity",  "https://www.perplexity.ai/search?q={q}"); //✏
	MapURL.Вставить("bing",        "https://www.bing.com/search?q={q}"); //✏
	MapURL.Вставить("gemini",      "https://gemini.google.com/?q={q}"); //✏
	MapURL.Вставить("you",         "https://you.com/search?q={q}&tbm=youchat"); //✏
	MapURL.Вставить("huggingchat", "https://huggingface.co/chat/?q={q}"); //✏
	MapURL.Вставить("chatglm",     "https://chat.z.ai/?q={q}"); //✏
	
	Возврат MapURL; //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_NormalizePlatformName
// <doc>
//   <summary>Нормализует имя платформы и разворачивает алиасы.</summary>   ✦
//   <param i="1" name="Name" type="String">Имя или алиас платформы.</param>
//   <returns>String — каноническое имя платформы ("chatgpt", "perplexity" и т.д.).</returns>
//   <complexity cc="6"/>
// </doc>
Функция NormalizePlatformName(Name) Экспорт //⚙
	ib = "Нормализация имени платформы"; //✍
	
	Норм = НРег(?(ТипЗнч(Name) = Тип("Строка"), СтрЗаменить(Name, " ", ""), "")); //✏
	Если Норм = "" Тогда Возврат "chatgpt"; КонецЕсли; //⚡↩
	
	// Лёгкие алиасы
	Если Норм = "gpt" Или Норм = "oai" Тогда Возврат "chatgpt"; КонецЕсли; //⚡↩
	Если Норм = "pplx" Тогда Возврат "perplexity"; КонецЕсли; //⚡↩
	Если Норм = "msbing" Тогда Возврат "bing"; КонецЕсли; //⚡↩
	Если Норм = "you.com" Тогда Возврат "you"; КонецЕсли; //⚡↩
	
	Возврат Норм; //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_BuildURL
// <doc>
//   <summary>Строит итоговый URL по имени платформы и закодированному запросу.</summary>   ✦
//   <param i="1" name="PlatformName" type="String">Каноническое имя платформы.</param>
//   <param i="2" name="EncodedQuery" type="String">Уже URL-кодированный запрос.</param>
//   <returns>String — итоговый URL или ПустаяСтрока при неподдерживаемой платформе.</returns>
//   <complexity cc="2"/>
// </doc>
Функция BuildURL(PlatformName, EncodedQuery) Экспорт //⚙
	ib = "Построение URL для платформы"; //✍
	
	Templates = GetPlatformsMap(); //✏
	Tpl = Templates[PlatformName]; //✏
	Если Tpl = Неопределено Тогда //⚡
		Возврат ""; //↩
	КонецЕсли;
	
	Возврат СтрЗаменить(Tpl, "{q}", EncodedQuery); //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_ListPlatforms
// <doc>
//   <summary>Возвращает список доступных платформ (через М1сAIОбщие.Ключи).</summary>   ✦
//   <returns>Массив — имена платформ в виде массива строк.</returns>
//   <complexity cc="1"/>
// </doc>
Функция ListPlatforms() Экспорт //⚙
	ib = "Список доступных платформ"; //✍
	
	Возврат М1сAIОбщие.Ключи(GetPlatformsMap()); //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_NewRNG
// <doc>
//   <summary>Создаёт новый генератор случайных чисел. Если Seed задан — детерминированный.</summary>   ✦
//   <param i="1" name="Seed" type="Число" default="Неопределено">Seed для детерминированности.</param>
//   <returns>ГенераторСлучайныхЧисел — новый экземпляр ГСЧ.</returns>
//   <complexity cc="2"/>
// </doc>
Функция NewRNG(Seed = Неопределено) Экспорт //⚙
	ib = "Создание генератора случайных чисел"; //✍
	
	Если Seed = Неопределено Тогда //⚡
		Возврат Новый ГенераторСлучайныхЧисел(); //↩
	Иначе
		Возврат Новый ГенераторСлучайныхЧисел(Seed); //↩
	КонецЕсли;
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_PickRandomPlatform
// <doc>
//   <summary>Возвращает случайную платформу из карты шаблонов URL, используя новый ГСЧ.</summary>   ✦
//   <param i="1" name="Templates" type="Соответствие">Карта платформ (ключи: имена платформ).</param>
//   <param i="2" name="Seed" type="Число" default="Неопределено">Seed для детерминированности (опционально).</param>
//   <returns>String — имя случайной платформы, либо ПустаяСтрока.</returns>
//   <complexity cc="4"/>
// </doc>
Функция PickRandomPlatform(Templates, Seed = Неопределено) Экспорт //⚙
	ib = "Выбор случайной платформы"; //✍
	
	Keys = М1сAIОбщие.Ключи(Templates); //✏
	
	// Убрать потенциальный "random"
	i = 0; //✏
	Пока i < Keys.Количество() Цикл //⟳
		Если Keys[i] = "random" Тогда //⚡
			Keys.Удалить(i); //✏
			Продолжить;
		КонецЕсли;
		i = i + 1; //✏
	КонецЦикла;
	
	Если Keys.Количество() = 0 Тогда //⚡
		Возврат ""; //↩
	КонецЕсли;
	
	RNG = NewRNG(Seed); //✏
	n = Keys.Количество(); //✏
	r = RNG.СлучайноеЧисло(); //✏
	idx = Мин(n - 1, Цел(r * n)); //✏
	
	Возврат Keys[idx]; //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_BuildEnrichedPrompt
// <doc>
//   <summary>Формирует обогащенный промпт из основного текста и до 8 дополнительных параметров.</summary>   ✦
//   <param i="1" name="ОсновнойТекст" type="String">Основной текст промпта.</param>
//   <param i="2" name="Обогащение1" type="String" default="Неопределено">Дополнительный контекст (роль, стиль и т.п.).</param>
//   <param i="3" name="Обогащение2" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="4" name="Обогащение3" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="5" name="Обогащение4" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6" name="Обогащение5" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="7" name="Обогащение6" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="8" name="Обогащение7" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="9" name="Обогащение8" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>String — сформированный полный промпт с обогащениями в начале.</returns>
//   <complexity cc="3"/>
// </doc>
Функция BuildEnrichedPrompt(ОсновнойТекст,
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено,
	Обогащение4 = Неопределено,
	Обогащение5 = Неопределено,
	Обогащение6 = Неопределено,
	Обогащение7 = Неопределено,
	Обогащение8 = Неопределено) Экспорт //⚙
	
	ib = "Формирование обогащенного промпта"; //✍
	
	МассивОбогащений = Новый Массив; //✏
	МассивОбогащений.Добавить(Обогащение1); //✏
	МассивОбогащений.Добавить(Обогащение2); //✏
	МассивОбогащений.Добавить(Обогащение3); //✏
	МассивОбогащений.Добавить(Обогащение4); //✏
	МассивОбогащений.Добавить(Обогащение5); //✏
	МассивОбогащений.Добавить(Обогащение6); //✏
	МассивОбогащений.Добавить(Обогащение7); //✏
	МассивОбогащений.Добавить(Обогащение8); //✏
	
	Результат = ""; //✏
	
	// Добавляем обогащения в начало промпта
	Для Каждого Обогащение Из МассивОбогащений Цикл //⟳
		Если ТипЗнч(Обогащение) = Тип("Строка") И НЕ ПустаяСтрока(Обогащение) Тогда //⚡
			Результат = Результат + Обогащение + Символы.ПС + Символы.ПС; //✏
		КонецЕсли;
	КонецЦикла;
	
	// Добавляем основной текст
	Результат = Результат + ОсновнойТекст; //✏
	
	Возврат Результат; //↩
КонецФункции
#EndRegion


#Region М1сAIИнтеграция_BuildRolePrompt
// <doc>
//   <summary>Формирует обогащенный промпт с ролью, действием и контекстом (БЕЗ открытия браузера).</summary>   ✦
//   <param i="1" name="РольИмя" type="String">Имя роли (Гендир, Финдир, Главбух и т.д.).</param>
//   <param i="2" name="ТекстЗапроса" type="String">Основной текст запроса.</param>
//   <param i="3" name="КодДействия" type="String" default="">Код действия из GetRoleActions (опционально).</param>
//   <param i="4" name="Обогащение1" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="5" name="Обогащение2" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6" name="Обогащение3" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>String — готовый обогащенный промпт для AI.</returns>
//   <complexity cc="3"/>
//   <example>
//     // Получить промпт БЕЗ отправки в AI
//     Промпт = М1сAIИнтеграция.BuildRolePrompt("Кадровик", "менеджер по продажам", "ОписаниеВакансии");
//     // Промпт содержит: описание роли + действие + запрос
//     
//     // Теперь можно показать пользователю, сохранить или отправить
//     М1сAIИнтеграция.OpenChatGPT(Промпт);
//   </example>
// </doc>
Функция BuildRolePrompt(РольИмя, ТекстЗапроса, КодДействия = "",
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено) Экспорт //⚙
	
	ib = "Формирование промпта с ролью"; //✍
	
	// Получаем описание роли
	РольОписание = М1сAIRoles.GetRoleDescription(РольИмя); //✏
	
	// Получаем описание действия (если указано)
	ДействиеОписание = ""; //✏
	Если НЕ ПустаяСтрока(КодДействия) Тогда //⚡
		Действия = М1сAIRoles.GetRoleActions(РольИмя); //✏
		Если Действия[КодДействия] <> Неопределено Тогда //⚡
			ДействиеОписание = Действия[КодДействия]; //✏
		КонецЕсли;
	КонецЕсли;
	
	// Формируем полный запрос
	ПолныйЗапрос = ТекстЗапроса; //✏
	Если НЕ ПустаяСтрока(ДействиеОписание) Тогда //⚡
		ПолныйЗапрос = ДействиеОписание + ": " + ТекстЗапроса; //✏
	КонецЕсли;
	
	// Формируем обогащенный промпт
	Промпт = BuildEnrichedPrompt( //✏
		ПолныйЗапрос,
		РольОписание,
		Обогащение1,
		Обогащение2,
		Обогащение3
	);
	
	Возврат Промпт; //↩
КонецФункции

#Region М1сAIИнтеграция_BuildRolePrompt_Test
Функция BuildRolePrompt_Test()
	ib = "Тест BuildRolePrompt"; //✍
	
	// Тест 1: Промпт с ролью без действия
	Промпт1 = BuildRolePrompt("Гендир", "Как увеличить прибыль?"); //✏
	Если ПустаяСтрока(Промпт1) Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	Если СтрНайти(НРег(Промпт1), "генеральный директор") = 0 Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	// Тест 2: Промпт с ролью и действием
	Промпт2 = BuildRolePrompt("Кадровик", "менеджер по продажам", "ОписаниеВакансии"); //✏
	Если ПустаяСтрока(Промпт2) Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	Если СтрНайти(Промпт2, "Составь привлекательное описание вакансии") = 0 Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	// Тест 3: Промпт с несуществующей ролью
	Промпт3 = BuildRolePrompt("НесуществующаяРоль", "Тест"); //✏
	Если СтрНайти(Промпт3, "Тест") = 0 Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	// Тест 4: Промпт с дополнительными обогащениями
	Промпт4 = BuildRolePrompt("Финдир", "Составь бюджет", "", //✏
		"КОНТЕКСТ: Компания в розничной торговле");
	Если СтрНайти(Промпт4, "КОНТЕКСТ") = 0 Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_Open
// <doc>
//   <summary>Открывает AI-запрос в выбранной платформе (по умолчанию — ChatGPT). Поддерживает "random" и обогащения.</summary>   ✦
//   <param i="1"  name="ТекстПромпта"  type="String">Текст запроса к ИИ.</param>
//   <param i="2"  name="PlatformName"  type="String" default="chatgpt">Имя платформы или "random".</param>
//   <param i="3"  name="Обогащение1"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="4"  name="Обогащение2"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="5"  name="Обогащение3"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6"  name="Обогащение4"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="7"  name="Обогащение5"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="8"  name="Обогащение6"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="9"  name="Обогащение7"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="10" name="Обогащение8"   type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>Boolean — удалось ли открыть браузер с запросом.</returns>
//   <complexity cc="5"/>
// </doc>
Функция Open(ТекстПромпта, 
	PlatformName = "chatgpt",
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено,
	Обогащение4 = Неопределено,
	Обогащение5 = Неопределено,
	Обогащение6 = Неопределено,
	Обогащение7 = Неопределено,
	Обогащение8 = Неопределено) Экспорт //⚙
	
	ib = "Открытие AI-запроса в платформе"; //✍
	
	Если ТипЗнч(ТекстПромпта) <> Тип("Строка") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	// Формируем обогащенный промпт
	ПолныйПромпт = BuildEnrichedPrompt( //✏
		ТекстПромпта,
		Обогащение1, Обогащение2, Обогащение3, Обогащение4,
		Обогащение5, Обогащение6, Обогащение7, Обогащение8
	);
	
	Enc = URLEncode(ПолныйПромпт); //✏
	Canon = NormalizePlatformName(PlatformName); //✏
	
	Templates = GetPlatformsMap(); //✏
	
	// Random через М1сAIОбщие.Ключи(...)
	Если Canon = "random" Тогда //⚡
		Canon = PickRandomPlatform(Templates); //✏
		Если Canon = "" Тогда Возврат Ложь; КонецЕсли; //⚡↩
	КонецЕсли;
	
	URL = BuildURL(Canon, Enc); //✏
	Если URL = "" Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат OpenBrowser(URL); //↩
КонецФункции

#Region М1сAIИнтеграция_Open_Test
Функция Open_Test()
	ib = "Тест Open"; //✍
	
	Результат = Open(123); //✏
	Если Результат <> Ложь Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = Open("Как работает 1С?"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = Open("Как работает 1С?", "perplexity"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = Open("Как работает 1С?", "неизвестная"); //✏
	Если Результат <> Ложь Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_OpenWithRole
// <doc>
//   <summary>Открывает AI-запрос с автоматическим получением роли и действия.</summary>   ✦
//   <param i="1" name="РольИмя" type="String">Имя роли (Гендир, Финдир, Главбух и т.д.).</param>
//   <param i="2" name="ТекстЗапроса" type="String">Основной текст запроса.</param>
//   <param i="3" name="КодДействия" type="String" default="">Код действия из GetRoleActions (опционально).</param>
//   <param i="4" name="PlatformName" type="String" default="chatgpt">Имя платформы.</param>
//   <param i="5" name="Обогащение1" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6" name="Обогащение2" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="7" name="Обогащение3" type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>Boolean — удалось ли открыть браузер с запросом.</returns>
//   <complexity cc="2"/>
//   <example>
//     // Быстрый способ: автоматически получает роль и действие
//     М1сAIИнтеграция.OpenWithRole("Кадровик", "менеджер по продажам", "ОписаниеВакансии", "chatgpt");
//     
//     // Эквивалентно:
//     РольОписание = М1сAIRoles.GetRoleDescription("Кадровик");
//     Действия = М1сAIRoles.GetRoleActions("Кадровик");
//     М1сAIИнтеграция.Open(Действия["ОписаниеВакансии"] + ": менеджер по продажам", "chatgpt", РольОписание);
//   </example>
// </doc>
Функция OpenWithRole(РольИмя, ТекстЗапроса, КодДействия = "", PlatformName = "chatgpt",
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено) Экспорт //⚙
	
	ib = "Открытие AI с ролью"; //✍
	
	// Формируем промпт
	Промпт = BuildRolePrompt(РольИмя, ТекстЗапроса, КодДействия, //✏
		Обогащение1, Обогащение2, Обогащение3);
	
	// Открываем в AI
	Возврат Open(Промпт, PlatformName); //↩
КонецФункции

#Region М1сAIИнтеграция_OpenWithRole_Test
Функция OpenWithRole_Test()
	ib = "Тест OpenWithRole"; //✍
	
	// Тест 1: Открытие с ролью
	Результат = OpenWithRole("Гендир", "Как увеличить прибыль?"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	// Тест 2: Открытие с ролью и действием
	Результат = OpenWithRole("Кадровик", "менеджер", "ОписаниеВакансии"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_OpenChatGPT
// <doc>
//   <summary>Открывает браузер с поисковым запросом в ChatGPT по тексту промпта с возможностью обогащения.</summary>   ✦
//   <param i="1" name="ТекстПромпта" type="String">Запрос к AI.</param>
//   <param i="2" name="Обогащение1"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="3" name="Обогащение2"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="4" name="Обогащение3"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="5" name="Обогащение4"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6" name="Обогащение5"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="7" name="Обогащение6"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="8" name="Обогащение7"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="9" name="Обогащение8"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>Boolean — успешно ли открыто.</returns>
//   <complexity cc="2"/>
// </doc>
Функция OpenChatGPT(ТекстПромпта,
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено,
	Обогащение4 = Неопределено,
	Обогащение5 = Неопределено,
	Обогащение6 = Неопределено,
	Обогащение7 = Неопределено,
	Обогащение8 = Неопределено) Экспорт //⚙
	
	ib = "Открытие запроса в ChatGPT"; //✍
	
	Если ТипЗнч(ТекстПромпта) <> Тип("Строка") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	ПолныйПромпт = BuildEnrichedPrompt( //✏
		ТекстПромпта,
		Обогащение1, Обогащение2, Обогащение3, Обогащение4,
		Обогащение5, Обогащение6, Обогащение7, Обогащение8
	);
	
	ТекстЗапроса = URLEncode(ПолныйПромпт); //✏
	URL = "https://chat.openai.com/?q=" + ТекстЗапроса; //✏
	
	Возврат OpenBrowser(URL); //↩
КонецФункции

#Region М1сAIИнтеграция_OpenChatGPT_Test
Функция OpenChatGPT_Test()
	ib = "Тест OpenChatGPT"; //✍
	
	Результат = OpenChatGPT("Привет, мир!"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = OpenChatGPT(123); //✏
	Если Результат <> Ложь Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_OpenPerplexity
// <doc>
//   <summary>Открывает браузер с поисковым запросом в Perplexity.ai по тексту промпта с возможностью обогащения.</summary>   ✦
//   <param i="1" name="ТекстПромпта" type="String">Запрос к AI.</param>
//   <param i="2" name="Обогащение1"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="3" name="Обогащение2"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="4" name="Обогащение3"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="5" name="Обогащение4"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="6" name="Обогащение5"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="7" name="Обогащение6"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="8" name="Обогащение7"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <param i="9" name="Обогащение8"  type="String" default="Неопределено">Дополнительный контекст.</param>
//   <returns>Boolean — успешно ли открыто.</returns>
//   <complexity cc="2"/>
// </doc>
Функция OpenPerplexity(ТекстПромпта,
	Обогащение1 = Неопределено,
	Обогащение2 = Неопределено,
	Обогащение3 = Неопределено,
	Обогащение4 = Неопределено,
	Обогащение5 = Неопределено,
	Обогащение6 = Неопределено,
	Обогащение7 = Неопределено,
	Обогащение8 = Неопределено) Экспорт //⚙
	
	ib = "Открытие запроса в Perplexity"; //✍
	
	Если ТипЗнч(ТекстПромпта) <> Тип("Строка") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	ПолныйПромпт = BuildEnrichedPrompt( //✏
		ТекстПромпта,
		Обогащение1, Обогащение2, Обогащение3, Обогащение4,
		Обогащение5, Обогащение6, Обогащение7, Обогащение8
	);
	
	ТекстЗапроса = URLEncode(ПолныйПромпт); //✏
	URL = "https://www.perplexity.ai/search?q=" + ТекстЗапроса; //✏
	
	Возврат OpenBrowser(URL); //↩
КонецФункции

#Region М1сAIИнтеграция_OpenPerplexity_Test
Функция OpenPerplexity_Test()
	ib = "Тест OpenPerplexity"; //✍
	
	Результат = OpenPerplexity("Привет, мир!"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = OpenPerplexity(123); //✏
	Если Результат <> Ложь Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_OpenBrowser
// <doc>
//   <summary>Открывает URL в браузере, возвращает успех операции.</summary>   ✦
//   <param i="1" name="URL" type="String">Ссылка для открытия.</param>
//   <returns>Boolean — удалось ли открыть.</returns>
//   <complexity cc="2"/>
// </doc>
Функция OpenBrowser(URL) Экспорт //⚙
	ib = "Открытие URL в браузере"; //✍
	
	Если ТипЗнч(URL) <> Тип("Строка") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Попытка //✱
		ЗапуститьПриложение(URL); //✏
		Возврат Истина; //↩
	Исключение
		Возврат Ложь; //↩
	КонецПопытки;
КонецФункции

#Region М1сAIИнтеграция_OpenBrowser_Test
Функция OpenBrowser_Test()
	ib = "Тест OpenBrowser"; //✍
	
	Результат = OpenBrowser(123); //✏
	Если Результат <> Ложь Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Результат = OpenBrowser("https://ya.ru"); //✏
	Если ТипЗнч(Результат) <> Тип("Булево") Тогда //⚡
		Возврат Ложь; //↩
	КонецЕсли;
	
	Возврат Истина; //↩
КонецФункции
#EndRegion
#EndRegion


#Region М1сAIИнтеграция_SelfTest
// <doc>
//   <summary>Запускает все тесты модуля М1сAIИнтеграция.</summary>   ✦
//   <returns>Boolean — успешно ли пройдены все тесты.</returns>
//   <complexity cc="10"/>
// </doc>
Функция SelfTest() Экспорт //⚙
	ib = "Самотестирование модуля М1сAIИнтеграция"; //✍
	
	Ошибки = Новый Массив; //✏
	
	М1сAIСтроки.Print("=== Тестирование модуля М1сAIИнтеграция v1.3.0 (с поддержкой ролей) ==="); //▶️
	
	// Вызов теста для URLEncode
	Если Не URLEncode_Test() Тогда //⚡
		Ошибки.Добавить("URLEncode_Test"); //✏
	КонецЕсли;
	
	// Вызов теста для OpenBrowser
	Если Не OpenBrowser_Test() Тогда //⚡
		Ошибки.Добавить("OpenBrowser_Test"); //✏
	КонецЕсли;
	
	// Вызов теста для OpenChatGPT
	Если Не OpenChatGPT_Test() Тогда //⚡
		Ошибки.Добавить("OpenChatGPT_Test"); //✏
	КонецЕсли;
	
	// Вызов теста для OpenPerplexity
	Если Не OpenPerplexity_Test() Тогда //⚡
		Ошибки.Добавить("OpenPerplexity_Test"); //✏
	КонецЕсли;
	
	// Вызов теста для Open
	Если Не Open_Test() Тогда //⚡
		Ошибки.Добавить("Open_Test"); //✏
	КонецЕсли;
	
	// НОВЫЕ ТЕСТЫ v1.3.0
	// Вызов теста для BuildRolePrompt
	Если Не BuildRolePrompt_Test() Тогда //⚡
		Ошибки.Добавить("BuildRolePrompt_Test"); //✏
	КонецЕсли;
	
	// Вызов теста для OpenWithRole
	Если Не OpenWithRole_Test() Тогда //⚡
		Ошибки.Добавить("OpenWithRole_Test"); //✏
	КонецЕсли;
	
	// Дополнительные тесты для работы с ролями
	М1сAIСтроки.Print("--- Тестирование работы с ролями ---"); //▶️
	
	// Тест 1: BuildRolePrompt с Кадровик
	Промпт1 = BuildRolePrompt("Кадровик", "менеджер по продажам", "ОписаниеВакансии"); //✏
	М1сAIСтроки.PrintYN(НЕ ПустаяСтрока(Промпт1), //▶️
		"✓ BuildRolePrompt с ролью и действием", 
		"✗ Ошибка BuildRolePrompt");
	
	// Тест 2: OpenWithRole
	Результат2 = OpenWithRole("Гендир", "Как увеличить прибыль?", "", "chatgpt"); //✏
	М1сAIСтроки.PrintYN(ТипЗнч(Результат2) = Тип("Булево"), //▶️
		"✓ OpenWithRole работает", 
		"✗ Ошибка OpenWithRole");
	
	// Вывод результатов
	Если Ошибки.Количество() > 0 Тогда //⚡
		М1сAIСтроки.Print("❌ Не пройдены тесты: " + М1сAIСтроки.AsString(Ошибки)); //▶️
		Возврат Ложь; //↩
	КонецЕсли;
	
	М1сAIСтроки.Print("✅ Все тесты модуля М1сAIИнтеграция пройдены!"); //▶️
	Возврат Истина; //↩
КонецФункции
#EndRegion

// ---------------------------- EOF М1сAIИнтеграция --------------------------------

