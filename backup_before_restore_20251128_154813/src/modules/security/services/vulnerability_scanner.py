"""
Vulnerability Scanner Service

Сервис для сканирования уязвимостей в коде.
"""

import re
from typing import List

from src.modules.security.domain.exceptions import VulnerabilityScanError
from src.modules.security.domain.models import (Severity, Vulnerability,
                                                VulnerabilityScanResult,
                                                VulnerabilityType)
from src.utils.structured_logging import StructuredLogger

logger = StructuredLogger(__name__).logger


class VulnerabilityScanner:
    """
    Сервис сканирования уязвимостей

    Features:
    - SQL injection detection
    - XSS detection
    - CSRF detection
    - Path traversal detection
    - Risk score calculation
    """

    def __init__(self, patterns_repository=None):
        """
        Args:
            patterns_repository: Repository для паттернов уязвимостей
                                (опционально, для dependency injection)
        """
        if patterns_repository is None:
            from src.modules.security.repositories import \
                SecurityPatternsRepository
            patterns_repository = SecurityPatternsRepository()

        self.patterns_repository = patterns_repository
        self.vulnerability_patterns = (
            self.patterns_repository.get_vulnerability_patterns()
        )

    async def scan_vulnerabilities(
        self,
        code: str,
        language: str = "python"
    ) -> VulnerabilityScanResult:
        """
        Сканирование кода на уязвимости

        Args:
            code: Код для сканирования
            language: Язык программирования

        Returns:
            VulnerabilityScanResult
        """
        try:
