# GBNF Generator для BSL

Автоматическая генерация GBNF грамматики для BSL (1С:Enterprise).

## Что это?

GBNF (GGML BNF) - формат грамматики для llama.cpp, позволяющий ограничивать генерацию LLM только синтаксически корректным кодом.

**Преимущества:**

- ✅ Гарантия синтаксической корректности
- ✅ Ускорение генерации
- ✅ Снижение hallucinations

## Использование

### 1. Генерация GBNF грамматики

```bash
cd c:\1cAI
python src\gbnf_generator\gbnf_generator.py
```

Результат: файл `bsl.gbnf` с полной грамматикой BSL.

### 2. Использование с llama.cpp

```bash
# Генерация кода с grammar constraint
./llama-cli \
    --model llama-3-8b.gguf \
    --grammar-file bsl.gbnf \
    --prompt "Создай функцию для расчета НДС"
```

**Результат:**

```bsl
Функция РассчитатьНДС(Сумма, СтавкаНДС = 20)
    Возврат Сумма * СтавкаНДС / 100;
КонецФункции
```

Гарантированно синтаксически корректный код!

## Структура

```
src/gbnf_generator/
├── bsl_grammar_rules.py  # Правила BSL грамматики
├── gbnf_generator.py     # Генератор GBNF
└── README.md             # Эта документация
```

## Поддерживаемые конструкции

### Ключевые слова

- ✅ Русский и английский синтаксис
- ✅ Регистронезависимость
- ✅ Все основные конструкции BSL

**Примеры:**

- `Функция` / `Function` / `ФУНКЦИЯ`
- `Если` / `If` / `ЕСЛИ`
- `Для` / `For` / `ДЛЯ`

### Конструкции

- ✅ Функции и процедуры
- ✅ Условия (if/elsif/else)
- ✅ Циклы (for/while/for each)
- ✅ Исключения (try/except)
- ✅ Переменные
- ✅ Выражения и операторы

### Токены

- ✅ Идентификаторы (кириллица + латиница)
- ✅ Числа (целые и дробные)
- ✅ Строки (двойные и одинарные кавычки)
- ✅ Комментарии

## Примеры использования

### Генерация функции

**Промпт:**

```
Создай функцию сложения двух чисел
```

**Результат:**

```bsl
Функция Сложить(Число1, Число2)
    Возврат Число1 + Число2;
КонецФункции
```

### Генерация процедуры с условием

**Промпт:**

```
Создай процедуру проверки возраста
```

**Результат:**

```bsl
Процедура ПроверитьВозраст(Возраст)
    Если Возраст >= 18 Тогда
        Сообщить("Совершеннолетний");
    Иначе
        Сообщить("Несовершеннолетний");
    КонецЕсли;
КонецПроцедуры
```

### Генерация цикла

**Промпт:**

```
Создай цикл для обхода массива
```

**Результат:**

```bsl
Для Каждого Элемент Из Массив Цикл
    Сообщить(Элемент);
КонецЦикла;
```

## Расширение

Для добавления новых конструкций:

1. Отредактируйте `bsl_grammar_rules.py`
2. Добавьте новые ключевые слова в `KEYWORDS`
3. Добавьте новые правила в `GRAMMAR_RULES`
4. Перегенерируйте GBNF: `python gbnf_generator.py`

## Интеграция с AI Orchestrator

```python
from gbnf_generator import GBNFGenerator

# Генерация грамматики
generator = GBNFGenerator()
grammar = generator.generate()

# Использование с LLM
response = llm.generate(
    prompt="Создай функцию",
    grammar=grammar
)
```

## Troubleshooting

### Ошибка "Invalid grammar"

- Проверьте синтаксис GBNF
- Убедитесь что все правила определены
- Проверьте кавычки и спецсимволы

### Генерация невалидного кода

- Обновите правила грамматики
- Добавьте недостающие конструкции
- Проверьте промпт

## Ссылки

- [llama.cpp](https://github.com/ggerganov/llama.cpp)
- [GBNF Format](https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md)
- [BSL Language Server](https://github.com/1c-syntax/bsl-language-server)
